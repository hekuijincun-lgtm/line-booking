[CmdletBinding()]
param(
    [Parameter(Mandatory)]
    [string]$Name,          # è¡¨ç¤ºå "Esthe"

    [Parameter(Mandatory)]
    [string]$Slug,          # "esthe"

    [string]$Primary = "#0A1A2F",
    [string]$Accent  = "#D4AF37",
    [string]$Surface = "#FFFFFF",

    [string]$RepoRoot = "$HOME/repo/line-booking"
)

$ErrorActionPreference = "Stop"

$uiRoot     = Join-Path $RepoRoot "booking-ui"
$tplDir     = Join-Path $uiRoot "templates"
$tplPath    = Join-Path $tplDir "$Slug.yaml"
$indexPath  = Join-Path $tplDir "index.json"

if (-not (Test-Path $tplDir)) {
    Write-Host "ğŸ“ Create templates dir: $tplDir"
    New-Item -ItemType Directory -Path $tplDir -Force | Out-Null
}

if (Test-Path $tplPath) {
    throw "ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ $Slug ã¯æ—¢ã«å­˜åœ¨ã™ã‚‹: $tplPath"
}

$yaml = @"
# Auto-generated by New-BookingTemplate.ps1
name: "$Name"
slug: "$Slug"

brand:
  primary: "$Primary"
  accent: "$Accent"
  surface: "$Surface"

layout:
  hero:
    title: "$Name äºˆç´„"
    subtitle: "ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä½“é¨“ã‚’ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã§ç°¡å˜äºˆç´„"
    description: "$Name ç”¨ã®èª¬æ˜æ–‡ã‚’ã“ã“ã«æ›¸ã"
    image: "/img/$Slug/hero.webp"
    ctaLabel: "ä»Šã™ãäºˆç´„ã™ã‚‹"

  sections:
    - type: "features"
      title: "é¸ã°ã‚Œã‚‹ç†ç”±"
      items:
        - title: "ç‰¹å¾´1"
          description: "ã“ã“ã«ç‰¹å¾´1ã®èª¬æ˜ã‚’å…¥ã‚Œã‚‹"
        - title: "ç‰¹å¾´2"
          description: "ã“ã“ã«ç‰¹å¾´2ã®èª¬æ˜ã‚’å…¥ã‚Œã‚‹"

meta:
  tags:
    - "$Slug"
    - "booking"
  note: "å¿…è¦ã«å¿œã˜ã¦ç·¨é›†ã—ã¦ãã ã•ã„"
"@

Write-Host "ğŸ“ Create template yaml: $tplPath"
$yaml | Set-Content -Path $tplPath -Encoding UTF8

# index.json æ›´æ–°ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ä¸€è¦§ç”¨ï¼‰
if (Test-Path $indexPath) {
    $json = Get-Content $indexPath -Raw | ConvertFrom-Json
} else {
    $json = @()
}

# åŒã˜ slug ãŒã‚ã‚Œã°ä¸Šæ›¸ãã€ç„¡ã‘ã‚Œã°è¿½åŠ 
$json = @(
    $json | Where-Object { $_.slug -ne $Slug }
    [pscustomobject]@{
        name = $Name
        slug = $Slug
    }
)

$json | ConvertTo-Json -Depth 3 | Set-Content -Path $indexPath -Encoding UTF8

Write-Host "âœ… æ–°è¦ãƒ†ãƒ³ãƒ—ãƒ¬ $Slug ç”Ÿæˆå®Œäº†"
Write-Host "   - YAML : $tplPath"
Write-Host "   - index: $indexPath"
Write-Host ""
Write-Host "æ¬¡ã®URLã§ç¢ºèª (stg ä¾‹):"
Write-Host "  https://85283f05.booking-ui-4pk.pages.dev/?template=$Slug"
