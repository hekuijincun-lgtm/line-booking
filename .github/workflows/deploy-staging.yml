name: Deploy (staging)
on:
  push:
    branches: [master]
    paths:
      - "api/**"
      - "wrangler.toml"
      - "pnpm-lock.yaml"
concurrency:
  group: deploy-staging
  cancel-in-progress: true
jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: staging
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"
        working-directory: api

      - uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: true
        working-directory: api

      - name: Wrangler deploy (staging)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
        run: |
          npx wrangler --version
          npx wrangler deploy --env=staging
        working-directory: api

      - name: Smoke test /__health (staging)
        if: always()
        env:
          BASE_URL: ${{ secrets.BASE_URL_STAGING || secrets.BASE_URL }}
        run: |
          if [ -n "$BASE_URL" ]; then curl -fsS "$BASE_URL/__health"; else echo 'skip: BASE_URL not set'; fi

      - name: Notify failure (Discord/Slack)
        if: failure()
        env:
          WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -n "$WEBHOOK_URL" ]; then \
            curl -X POST -H 'Content-type: application/json' \
                 --data "{\"text\":\"‚ùå staging deploy failed: $GITHUB_REPOSITORY@$GITHUB_SHA\"}" \
                 "$WEBHOOK_URL"; \
          else echo 'skip: no webhook'; fi



