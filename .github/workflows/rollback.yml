name: Rollback Worker
on:
  workflow_dispatch:
    inputs:
      env:
        description: "environment (staging|production)"
        required: true
        default: "production"
      commit_sha:
        description: "Commit SHA to rollback to"
        required: true
jobs:
  rollback:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.env }}
    steps:
      - name: Checkout target commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.commit_sha }}

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"
        working-directory: api

      - uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: true
        working-directory: api

      - name: Deploy selected commit
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
        run: |
          if [ "${{ github.event.inputs.env }}" = "staging" ]; then
            npx wrangler deploy --env=staging
          else
            npx wrangler deploy --env=production
          fi
        working-directory: api

      - name: Notify rollback
        env:
          WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -n "$WEBHOOK_URL" ]; then \
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"↩️ rolled back ${{ github.event.inputs.env }} to ${{ github.event.inputs.commit_sha }}\"}" \
              "$WEBHOOK_URL"; \
          else echo 'skip: no webhook'; fi
