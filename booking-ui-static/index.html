<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Kazuki Booking | 予約フォーム</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="Cache-Control" content="public, max-age=300" />
  <meta name="description" content="Kazuki Group のオンライン予約フォームです。" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              navy: '#0f172a',
              navySoft: '#111827',
              gold: '#facc15',
              accent: '#1d4ed8'
            }
          }
        }
      }
    };
  </script>

  <script>
    const fallback = "https://saas-api-v4.hekuijincun.workers.dev";
    const q = new URL(location.href).searchParams;
    const API_BASE =
      q.get("api") === "stg"
        ? "https://saas-api-staging-v4.hekuijincun.workers.dev"
        : (q.get("api") && q.get("api").startsWith("http"))
          ? q.get("api")
          : fallback;

    let selectedSlotId = null;
    let selectedSlotLabel = "";
    let slotsCache = [];

    function setQuickDate(kind) {
      const d = new Date();
      if (kind === "tomorrow") {
        d.setDate(d.getDate() + 1);
      } else if (kind === "weekend") {
        const day = d.getDay(); // 0:日〜6:土
        let diff = (6 - day + 7) % 7;
        if (diff === 0) diff = 7; // 次の土曜
        d.setDate(d.getDate() + diff);
      }
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      const input = document.getElementById("date");
      input.value = yyyy + "-" + mm + "-" + dd;
    }

    async function loadSlots() {
      const dateInput = document.getElementById("date");
      const list = document.getElementById("slot-list");
      const msg = document.getElementById("system-message");

      selectedSlotId = null;
      selectedSlotLabel = "";
      list.innerHTML = "";
      msg.textContent = "";
      msg.className = "";

      const date = dateInput.value;
      if (!date) {
        msg.textContent = "日付を選択してください。";
        msg.className = "text-sm text-red-400 mt-2";
        return;
      }

      const loading = document.getElementById("slots-loading");
      loading.classList.remove("hidden");

      try {
        const res = await fetch(API_BASE + "/line/slots?date=" + encodeURIComponent(date));
        if (!res.ok) throw new Error("ステータスコード: " + res.status);
        const data = await res.json();
        slotsCache = data.slots || data || [];
        if (!Array.isArray(slotsCache) || slotsCache.length === 0) {
          list.innerHTML = '<p class="text-sm text-slate-300">この日付の空き枠はありません。</p>';
          return;
        }

        list.innerHTML = "";
        slotsCache.forEach(slot => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className =
            "slot-card w-full text-left px-4 py-3 mb-2 rounded-xl border border-slate-700 bg-slate-900/80 hover:border-brand-gold hover:bg-slate-800 transition flex items-center justify-between";
          const id = slot.id || slot.slotId || "";
          const label = slot.label || slot.time || slot.startTime || "時間未設定";
          const remain = (slot.remaining ?? slot.capacity ?? null);

          btn.dataset.slotId = id;
          btn.dataset.label = label;
          btn.dataset.remain = remain;

          let badgeHtml = "";
          if (remain !== null && remain !== undefined) {
            const isLow = Number(remain) <= 2;
            const badgeClass = isLow
              ? "bg-rose-500/10 text-rose-300 border-rose-400/70"
              : "bg-emerald-500/10 text-emerald-300 border-emerald-400/70";
            badgeHtml =
              '<span class="ml-3 inline-flex items-center rounded-full border ' +
              badgeClass +
              ' px-3 py-1 text-[11px] font-semibold">' +
              "残り " + remain + " 枠" +
              "</span>";
          }

          btn.innerHTML =
            '<div>' +
              '<div class="text-sm font-semibold text-slate-50">' + label + '</div>' +
              (remain !== null && remain !== undefined
                ? '<div class="text-xs text-slate-400 mt-0.5">早めのご予約をおすすめします。</div>'
                : "") +
            '</div>' +
            badgeHtml;

          btn.addEventListener("click", () => selectSlot(btn));
          list.appendChild(btn);
        });
      } catch (err) {
        console.error(err);
        msg.textContent = "空き枠の取得に失敗しました。少し時間をおいて再度お試しください。";
        msg.className = "text-sm text-red-400 mt-2";
      } finally {
        loading.classList.add("hidden");
      }
    }

    function selectSlot(element) {
      selectedSlotId = element.dataset.slotId || null;
      selectedSlotLabel = element.dataset.label || "";
      document.querySelectorAll(".slot-card").forEach(el => {
        el.classList.remove("border-brand-gold", "ring-2", "ring-brand-gold/60");
      });
      element.classList.add("border-brand-gold", "ring-2", "ring-brand-gold/60");
      const msg = document.getElementById("system-message");
      msg.textContent = "選択中の枠: " + (selectedSlotLabel || selectedSlotId || "なし");
      msg.className = "text-sm text-brand-gold mt-2";
    }

    function openConfirmModal() {
      const dateInput = document.getElementById("date");
      const nameInput = document.getElementById("name");
      const phoneInput = document.getElementById("phone");
      const msg = document.getElementById("system-message");

      msg.textContent = "";
      msg.className = "";

      if (!dateInput.value) {
        msg.textContent = "日付を選択してください。";
        msg.className = "text-sm text-red-400 mt-2";
        return;
      }
      if (!selectedSlotId) {
        msg.textContent = "予約する枠を選択してください。";
        msg.className = "text-sm text-red-400 mt-2";
        return;
      }
      if (!nameInput.value.trim()) {
        msg.textContent = "お名前を入力してください。";
        msg.className = "text-sm text-red-400 mt-2";
        return;
      }

      document.getElementById("confirm-date").textContent = dateInput.value;
      document.getElementById("confirm-slot").textContent = selectedSlotLabel || selectedSlotId;
      document.getElementById("confirm-name").textContent = nameInput.value.trim();
      document.getElementById("confirm-phone").textContent = phoneInput.value.trim() || "未入力";

      const modal = document.getElementById("confirm-modal");
      modal.classList.remove("hidden");
    }

    async function doReserve() {
      const dateInput = document.getElementById("date");
      const nameInput = document.getElementById("name");
      const phoneInput = document.getElementById("phone");
      const msg = document.getElementById("system-message");

      const payload = {
        slotId: selectedSlotId,
        name: nameInput.value.trim(),
        phone: phoneInput.value.trim()
      };

      const reserveBtn = document.getElementById("reserveBtn");
      reserveBtn.disabled = true;
      reserveBtn.classList.add("opacity-60", "cursor-wait");

      try {
        const res = await fetch(API_BASE + "/line/reserve", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const text = await res.text();
        if (!res.ok) {
          throw new Error("予約に失敗しました: " + res.status + " " + text);
        }

        msg.textContent = "予約が完了しました。LINEをご確認ください。";
        msg.className = "text-sm text-emerald-400 mt-2";

        const success = document.getElementById("success-panel");
        success.classList.remove("hidden");
        success.classList.remove("opacity-0", "translate-y-4");
        success.classList.add("opacity-100", "translate-y-0");
      } catch (err) {
        console.error(err);
        msg.textContent = "予約処理中にエラーが発生しました。時間をおいて再度お試しください。";
        msg.className = "text-sm text-red-400 mt-2";
      } finally {
        reserveBtn.disabled = false;
        reserveBtn.classList.remove("opacity-60", "cursor-wait");
        closeConfirmModal();
      }
    }

    function closeConfirmModal() {
      const modal = document.getElementById("confirm-modal");
      modal.classList.add("hidden");
    }

    function initForm() {
      const d = document.getElementById("date");
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, "0");
      const dd = String(now.getDate()).padStart(2, "0");
      d.value = yyyy + "-" + mm + "-" + dd;
    }

    document.addEventListener("DOMContentLoaded", () => {
      initForm();
      document.getElementById("loadSlotsBtn").addEventListener("click", loadSlots);
      document.getElementById("reserveBtn").addEventListener("click", openConfirmModal);
      document.getElementById("confirmYes").addEventListener("click", doReserve);
      document.getElementById("confirmNo").addEventListener("click", closeConfirmModal);

      document.getElementById("tab-today").addEventListener("click", () => setQuickDate("today"));
      document.getElementById("tab-tomorrow").addEventListener("click", () => setQuickDate("tomorrow"));
      document.getElementById("tab-weekend").addEventListener("click", () => setQuickDate("weekend"));
    });
  </script>
  
<style id="kb-theme-light">
  :root{
    --kb-surface:#ffffff;
    --kb-surface-2:#f8fafc;      /* header/subtle 背景 */
    --kb-border:#e5e7eb;
    --kb-text:#0f172a;           /* slate-900 */
    --kb-muted:#64748b;          /* slate-500 */
    --kb-brand:#2563eb;          /* blue-600 */
    --kb-brand-2:#60a5fa;        /* blue-400 */
    --kb-shadow:0 10px 30px rgba(15,23,42,.08);
    --kb-radius:16px;
  }

  /* カレンダーセクションのみライト化（全体へは波及しない） */
  #calendar-section.kb-card{
    color:var(--kb-text);
    background:var(--kb-surface);
    border:1px solid var(--kb-border);
    border-radius:var(--kb-radius);
    box-shadow:var(--kb-shadow);
  }
  #calendar-section .kb-title{
    margin:0 0 6px; font-size:18px; font-weight:700; letter-spacing:.01em;
  }
  #calendar-section .kb-sub{
    margin:0 0 14px; color:var(--kb-muted);
  }
  #calendar-section .kb-actions{
    display:flex; gap:12px; flex-wrap:wrap;
  }
  #calendar-section .kb-btn{
    padding:10px 16px; border-radius:999px; border:1px solid transparent;
    font-weight:700; cursor:pointer; transition:transform .05s ease, box-shadow .2s ease, opacity .2s ease;
  }
  #calendar-section .kb-btn:active{ transform:translateY(1px) }

  /* Primary（Google）: ブルーグラデ＋淡いシャドウ */
  #calendar-section .kb-btn-primary{
    color:#fff;
    background:linear-gradient(135deg, var(--kb-brand), var(--kb-brand-2));
    box-shadow:0 8px 24px rgba(37,99,235,.20);
  }
  #calendar-section .kb-btn-primary:hover{ opacity:.95 }

  /* Ghost（ICS）: 白背景＋グレー境界線 */
  #calendar-section .kb-btn-ghost{
    color:var(--kb-text);
    background:var(--kb-surface);
    border-color:var(--kb-border);
  }
  #calendar-section .kb-btn-ghost:hover{
    border-color:#d1d5db; /* slate-300 */
    box-shadow:0 6px 16px rgba(2,6,23,.05);
  }

  /* 小さなセクションヘッダー帯（任意のアクセント） */
  #calendar-section .kb-header {
    background:var(--kb-surface-2);
    border:1px solid var(--kb-border);
    border-radius:12px;
    padding:10px 12px;
    margin:0 0 12px;
  }
</style>
  <style id="kb-force-light">
  :root{
    --kb-text:#0f172a;         /* 濃い文字 */
    --kb-muted:#475569;        /* 補助文字 */
    --kb-border:#e7e9ee;       /* 枠線 */
    --kb-bg:#f7f8fb;           /* ページBG */
    --kb-card:#ffffff;         /* カード */
    --kb-em:#111827;           /* 見出し */
    --kb-link:#2563eb;         /* リンク/アクセント */
    --kb-focus:#2563eb33;      /* フォーカス影 */
    --kb-radius:16px;
    --kb-shadow:0 10px 28px rgba(15,23,42,.06);
  }
  /* ページ全体の視認性 */
  html{ scroll-behavior:smooth }
  body{
    background:var(--kb-bg) !important;
    color:var(--kb-text) !important;
    font: 16px/1.65 system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
    letter-spacing:.2px;
  }
  /* レイアウト幅を整える（中央寄せ、左右余白） */
  main, .container, .wrap, .page, .content {
    max-width: 980px;
    margin: 24px auto;
    padding: 0 18px;
  }

  /* カードを白く・影は軽めに */
  section, aside, .card{
    background:var(--kb-card) !important;
    border:1px solid var(--kb-border) !important;
    border-radius:var(--kb-radius) !important;
    box-shadow:var(--kb-shadow) !important;
  }

  /* ヒーロー部分が暗いままなら明度を上げる */
  header, .hero, .header-bar {
    background:linear-gradient(180deg, #ffffff 0%, #fbfcff 100%) !important;
    border-bottom:1px solid var(--kb-border) !important;
    box-shadow:none !important;
  }

  /* 見出しのコントラスト */
  h1{ color:var(--kb-em)!important; font-weight:800; font-size:clamp(22px, 3.2vw, 28px); line-height:1.2; margin:6px 0 10px }
  h2{ color:var(--kb-em)!important; font-weight:700; font-size:clamp(18px, 2.6vw, 22px); line-height:1.25; margin:0 0 8px }
  p, small, li, span{ color:var(--kb-muted) }

  /* 入力UI（input/select/textarea/ボタン） */
  input, select, textarea {
    background:#fff !important;
    border:1px solid var(--kb-border) !important;
    border-radius:12px !important;
    padding:12px 14px !important;
    box-shadow:0 2px 8px rgba(15,23,42,.04) !important;
    transition: box-shadow .15s ease, border-color .15s ease;
  }
  input:focus, select:focus, textarea:focus {
    outline:none !important;
    border-color:#2563eb !important;
    box-shadow:0 0 0 4px var(--kb-focus) !important;
  }

  /* ラベルや小見出し */
  label, .field-label, .form-label{ font-weight:600; color:#1f2937 }

  /* 小さな丸ボタン群（今日/明日/週末）を見やすく */
  .chip, .tag, .pill, button.chip{
    border:1px solid var(--kb-border);
    background:#fff;
    border-radius:999px;
    padding:8px 12px;
    font-weight:600;
  }
  .chip:hover{ background:#f4f6fb }

  /* 送信/確定ボタンは少し大きく、指で押しやすく */
  button, .btn{
    border-radius:999px !important;
    padding:12px 18px !important;
    font-weight:800 !important;
  }

  /* 成功パネルをライトな緑で */
  #success-panel{
    background:#f0fdf4 !important;       /* 明るい緑 */
    border:1px solid #bbf7d0 !important;
    color:#065f46 !important;
    box-shadow:none !important;
  }

  /* 空き枠リストの行間・区切り線 */
  #slots, .slot-list, .availability {
    border-radius:14px !important;
    background:#fff !important;
    border:1px solid var(--kb-border) !important;
  }
  .slot-item{
    display:flex; justify-content:space-between; align-items:center;
    padding:14px 14px; border-top:1px solid var(--kb-border);
  }
  .slot-item:first-child{ border-top:none }
  .slot-item .time { font-weight:700; color:var(--kb-em) }
  .slot-item .note { color:var(--kb-muted) }

  /* カレンダー追加セクション（白版） */
  #calendar-section{ padding:18px 20px }
  #calendar-section .kbL-actions{ display:flex; gap:12px; flex-wrap:wrap }
  #calendar-section .kbL-btn{
    padding:10px 16px; border-radius:999px; font-weight:700; border:1px solid transparent; cursor:pointer;
  }
  #calendar-section .kbL-btn-primary{
    color:#fff; background:linear-gradient(135deg,#1f2a44,#2563eb); box-shadow:0 8px 22px rgba(37,99,235,.18)
  }
  #calendar-section .kbL-btn-ghost{ background:#fff; border-color:var(--kb-border); color:var(--kb-text) }

  /* アクセシビリティ：リンク色とホバー */
  a{ color:var(--kb-link) }
  a:hover{ text-decoration:underline }

  /* 細い区切り */
  .divider{ height:1px; background:var(--kb-border); margin:16px 0 }
</style>
<style id="kb-force-light-brand-fix">
  header .subtitle,
  header .tagline,
  header small,
  .header-bar .subtitle,
  .header-bar small,
  .brand-subtitle{
    color: var(--kb-muted) !important;
    opacity: .95 !important;
  }
  /* サイト名/ブランド名は見出しカラーで少し濃く */
  header .brand,
  header .logo-text,
  .header-bar .brand,
  .header-bar .logo-text{
    color: var(--kb-em) !important;
  }
</style><style id="kb-muted-unify-v3">
  :root {
    --kb-muted: #6b7280;   /* calm gray */
    --kb-muted-weak: #9ca3af;
  }
  /* ロゴ横のサブタイトル想定 */
  .brand-subtitle,
  header .subtitle,
  header small,
  .site-subtitle { color: var(--kb-muted) !important; opacity: .95 !important; }

  /* 情報系（API_BASEなど）とコードを落ち着いたグレーに */
  .meta-muted, .meta-muted *, footer, footer small, code, kbd, samp {
    color: var(--kb-muted) !important;
  }

  /* 念のためデバッグIDは不可視 */
  #dbg-cal, #dbg-meta, #dbg-log, #dbg-gcal, #dbg-ics { display:none !important; visibility:hidden !important; }
</style>
<style id="kb-subtitle-gray-v3">
  :root {
    --kb-muted: #6b7280; /* calm gray */
  }
  /* よくある位置のサブタイトル（ロゴ横/ヘッダー内小文字） */
  header small,
  header .subtitle,
  .brand-subtitle,
  .site-subtitle,
  .header-bar small {
    color: var(--kb-muted) !important;
    font-weight: 600;
    letter-spacing: .1px;
    opacity: .95;
  }
</style>
<style id="kb-header-gray-v1">
  :root{
    --kb-header-bg:#f2f4f7;     /* 落ち着いた薄グレー */
    --kb-header-border:#e5e7eb; /* 1px 下境界 */
    --kb-header-text:#111827;   /* 文字は濃い目 */
    --kb-muted:#6b7280;         /* サブタイトル用 */
  }
  /* ヘッダー帯（候補を総当たりで上書き） */
  header, .site-header, .topbar, .navbar, .brand-bar, .page-header, .header-bar {
    background: var(--kb-header-bg) !important;
    color: var(--kb-header-text) !important;
    box-shadow: inset 0 -1px 0 var(--kb-header-border) !important;
    backdrop-filter: none !important;
  }
  /* ロゴ横の小見出し（Online Booking など） */
  header small, header .subtitle, .brand-subtitle, .site-subtitle, .header-bar small {
    color: var(--kb-muted) !important;
    font-weight: 600;
    letter-spacing: .1px;
    opacity: .95;
  }
</style>
<style id="kb-header-gray-extend-v2">
  :root{
    --kb-header-bg:#f2f4f7;    /* 落ち着いた薄グレー */
    --kb-header-text:#111827;
    --kb-muted:#6b7280;
    --kb-header-border:#e5e7eb;
  }
  /* header 以外の上部コンテナも含めて背景統一 */
  body > header,
  .header-wrapper,
  .site-header,
  .topbar,
  .navbar,
  .page-header,
  .header-bar,
  .top-section,
  .main-header,
  [class*="header"] {
    background: var(--kb-header-bg) !important;
    color: var(--kb-header-text) !important;
    border-bottom: 1px solid var(--kb-header-border) !important;
    box-shadow: none !important;
  }

  /* ロゴ横のOnline Bookingをグレーに */
  header small,
  header .subtitle,
  .brand-subtitle,
  .site-subtitle,
  .header-bar small {
    color: var(--kb-muted) !important;
    font-weight: 600;
    opacity: .95;
  }

  /* ヘッダー直下の背景継ぎ目が白くならないように */
  body, html {
    background-color: #f8fafc !important;
  }
</style>
<style id="kb-header-fullgray-v3">
  :root {
    --kb-header-bg: #f2f4f7;     /* 落ち着いたグレー */
    --kb-border: #e5e7eb;
    --kb-text: #111827;
    --kb-muted: #6b7280;
  }

  /* ヘッダーとその外側 */
  body, html {
    background-color: var(--kb-header-bg) !important;
  }

  header, 
  .header, 
  .header-wrapper, 
  .topbar, 
  .navbar, 
  .page-header, 
  .top-section, 
  .main-header, 
  .site-header, 
  .layout, 
  .wrapper, 
  .app, 
  [class*="header"], 
  [class*="top"], 
  [class*="nav"] {
    background: var(--kb-header-bg) !important;
    color: var(--kb-text) !important;
    border-bottom: 1px solid var(--kb-border) !important;
    box-shadow: none !important;
  }

  /* ロゴ横の「Online Booking」 */
  header small,
  header .subtitle,
  .brand-subtitle,
  .site-subtitle,
  .header-bar small {
    color: var(--kb-muted) !important;
    font-weight: 600;
    opacity: 0.95;
    letter-spacing: 0.1px;
  }

  /* 下セクションとのトーン差を軽減 */
  main, section, .content, .main-content {
    background-color: #f8fafc !important;
  }
</style>
<style id="kb-header-onlygray-v1">
  :root{
    --kb-header-bg:#f3f4f6;   /* 落ち着いたライトグレー */
    --kb-header-bd:#e5e7eb;
    --kb-sub-muted:#6b7280;
  }
  /* ヘッダー/ナビに限定してグレー化。main/section/body背景は触らない */
  header,
  .site-header,
  .main-header,
  .header,
  .topbar,
  .navbar { 
    background:var(--kb-header-bg) !important;
    border-bottom:1px solid var(--kb-header-bd) !important;
    box-shadow:none !important;
  }
  /* ヘッダーの親ラッパーも白帯を作る犯人になりがちなので一緒に上塗り */
  .header-wrapper,
  .header-bar,
  .masthead,
  .page-header,
  .layout-header,
  .wrapper-header,
  .top-section {
    background:var(--kb-header-bg) !important;
    border-bottom:1px solid var(--kb-header-bd) !important;
  }
  /* 「Online Booking」のトーンだけ落ち着かせる（見出しはそのまま） */
  header small,
  header .subtitle,
  .brand-subtitle {
    color:var(--kb-sub-muted) !important;
    font-weight:600;
    letter-spacing:.2px;
    opacity:.95;
  }
</style>
</head>

<body class="kb-force-light min-h-screen bg-slate-950 text-slate-50">
  <div class="min-h-screen bg-gradient-to-b from-slate-950 via-slate-900 to-slate-950">
    <header class="border-b border-slate-800/80 bg-slate-950/80 backdrop-blur">
      <div class="mx-auto max-w-3xl px-4 py-4 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <div class="h-9 w-9 rounded-xl bg-gradient-to-br from-brand-gold to-amber-500 flex items-center justify-center shadow-lg shadow-amber-500/30">
            <span class="text-xs font-extrabold text-slate-950">KG</span>
          </div>
          <div>
            <div class="text-sm font-semibold tracking-wide text-slate-50">
              Kazuki Group
            </div>
            <div class="text-[11px] text-slate-400">Online Booking</div>
          </div>
        </div>
        <span class="inline-flex items-center rounded-full border border-slate-700/80 px-3 py-1 text-[11px] font-medium text-slate-300">
          <span class="h-1.5 w-1.5 rounded-full bg-emerald-400 mr-1.5 animate-pulse"></span>
          稼働中
        </span>
      </div>
    </header>

    <main class="mx-auto max-w-3xl px-4 py-8">
      <div class="mb-6">
        <h1 class="text-2xl font-bold text-slate-50 tracking-tight">
          ご予約フォーム
        </h1>
        <p class="mt-1 text-sm text-slate-400">
          日付と空き枠を選択して、お名前・電話番号を入力してください。<br />
          予約完了後、LINEに確認メッセージが届きます。
        </p>
      </div>

      <div class="grid gap-6 lg:grid-cols-[minmax(0,2fr)_minmax(0,1.4fr)]">
        <section class="rounded-2xl border border-slate-800 bg-slate-900/70 p-5 shadow-xl shadow-black/40">
          <h2 class="mb-4 flex items-center gap-2 text-sm font-semibold text-slate-100">
            <span class="h-6 w-1 rounded-full bg-gradient-to-b from-brand-gold to-amber-500"></span>
            予約内容の入力
          </h2>

          <div class="space-y-4">
            <div>
              <div class="grid gap-4 sm:grid-cols-2">
                <div>
                  <label for="date" class="mb-1 block text-xs font-medium text-slate-300">
                    日付<span class="ml-1 text-amber-400">*</span>
                  </label>
                  <input
                    id="date"
                    type="date"
                    class="w-full rounded-xl border border-slate-700 bg-slate-900/80 px-3 py-2 text-sm text-slate-50 shadow-inner shadow-black/40 focus:border-brand-gold focus:outline-none focus:ring-1 focus:ring-brand-gold/70"
                  />
                  <div class="mt-2 flex flex-wrap gap-2 text-[11px]">
                    <button
                      id="tab-today"
                      type="button"
                      class="rounded-full border border-slate-700 bg-slate-900/80 px-3 py-1 text-[11px] text-slate-200 hover:border-brand-gold/70 hover:bg-slate-800 transition"
                    >
                      今日
                    </button>
                    <button
                      id="tab-tomorrow"
                      type="button"
                      class="rounded-full border border-slate-700 bg-slate-900/80 px-3 py-1 text-[11px] text-slate-200 hover:border-brand-gold/70 hover:bg-slate-800 transition"
                    >
                      明日
                    </button>
                    <button
                      id="tab-weekend"
                      type="button"
                      class="rounded-full border border-slate-700 bg-slate-900/80 px-3 py-1 text-[11px] text-slate-200 hover:border-brand-gold/70 hover:bg-slate-800 transition"
                    >
                      週末
                    </button>
                  </div>
                </div>

                <div>
                  <label for="name" class="mb-1 block text-xs font-medium text-slate-300">
                    お名前<span class="ml-1 text-amber-400">*</span>
                  </label>
                  <input
                    id="name"
                    placeholder="山田太郎"
                    class="w-full rounded-xl border border-slate-700 bg-slate-900/80 px-3 py-2 text-sm text-slate-50 shadow-inner shadow-black/40 focus:border-brand-gold focus:outline-none focus:ring-1 focus:ring-brand-gold/70"
                  />
                </div>

                <div>
                  <label for="phone" class="mb-1 block text-xs font-medium text-slate-300">
                    電話番号（任意）
                  </label>
                  <input
                    id="phone"
                    placeholder="080-xxxx-xxxx"
                    class="w-full rounded-xl border border-slate-700 bg-slate-900/80 px-3 py-2 text-sm text-slate-50 shadow-inner shadow-black/40 focus:border-brand-gold focus:outline-none focus:ring-1 focus:ring-brand-gold/70"
                  />
                </div>
              </div>
            </div>

            <div class="flex items-center justify-between gap-3">
              <button
                id="loadSlotsBtn"
                type="button"
                class="inline-flex items-center gap-1.5 rounded-xl border border-slate-700 bg-slate-900/80 px-3 py-2 text-xs font-medium text-slate-100 hover:border-brand-gold/70 hover:bg-slate-800 transition"
              >
                <span class="h-1.5 w-1.5 rounded-full bg-slate-400"></span>
                空き枠を読み込む
              </button>

              <button
                id="reserveBtn"
                type="button"
                class="inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-brand-gold via-amber-400 to-yellow-400 px-4 py-2 text-xs font-semibold text-slate-950 shadow-lg shadow-amber-500/40 hover:brightness-105 active:scale-[0.98] transition"
              >
                予約を確定する
              </button>
            </div>

            <p id="system-message" class="text-sm text-slate-300 mt-1"></p>

            <div id="slots-loading" class="mt-2 hidden text-xs text-slate-400">
              読み込み中です…
            </div>

            <div class="mt-3 rounded-xl border border-slate-800 bg-slate-950/60 p-3">
              <h3 class="mb-2 text-xs font-semibold text-slate-200">
                空き枠一覧
              </h3>
              <div id="slot-list" class="max-h-60 space-y-1 overflow-y-auto">
                <p class="text-xs text-slate-500">
                  「空き枠を読み込む」を押すと、この日に予約可能な時間が表示されます。
                </p>
              </div>
            </div>
          </div>
        </section>

        <aside class="space-y-4">
          <section class="rounded-2xl border border-slate-800 bg-slate-900/80 p-4 shadow-xl shadow-black/40">
            <h2 class="mb-3 text-xs font-semibold text-slate-100">
              予約のポイント
            </h2>
            <ul class="space-y-2 text-xs text-slate-300">
              <li class="flex gap-2">
                <span class="mt-[3px] h-1.5 w-1.5 rounded-full bg-brand-gold"></span>
                <span>日付を選択してから空き枠を表示できます。</span>
              </li>
              <li class="flex gap-2">
                <span class="mt-[3px] h-1.5 w-1.5 rounded-full bg-brand-gold"></span>
                <span>お名前は必須です。電話番号は折り返し連絡が必要な場合に使用します。</span>
              </li>
              <li class="flex gap-2">
                <span class="mt-[3px] h-1.5 w-1.5 rounded-full bg-brand-gold"></span>
                <span>予約完了後、LINEにて詳細をお送りします。</span>
              </li>
            </ul>
          </section>

          <section
            id="success-panel"
            class="hidden opacity-0 translate-y-4 rounded-2xl border border-emerald-500/40 bg-emerald-900/20 p-4 shadow-lg shadow-emerald-500/20 transition"
          >
            <h2 class="mb-1 text-xs font-semibold text-emerald-300">
              予約が完了しました
            </h2>
            <p class="text-xs text-emerald-100 mb-3">
              ありがとうございました。LINEアカウントに確認メッセージをお送りしましたので、ご確認ください。
            </p>
            <div class="flex flex-wrap gap-2 text-[11px]">
              <button
                type="button"
                class="rounded-full border border-emerald-400/70 bg-emerald-500/10 px-3 py-1 text-[11px] font-semibold text-emerald-100"
              >
                LINEのトーク画面を開いて確認する
              </button>
              <button
                type="button"
                class="rounded-full border border-slate-600 bg-slate-900/80 px-3 py-1 text-[11px] font-medium text-slate-200"
              >
                カレンダーに予定として追加する（ご自身のカレンダーアプリで）
              </button>
            </div>
          </section>
        </aside>
      </div>
    </main>

    <footer class="mt-8 border-t border-slate-800/80 bg-slate-950/80">
      <div class="mx-auto max-w-3xl px-4 py-3 flex items-center justify-between text-[10px] text-slate-500">
        <span>© Kazuki Group</span>
        <span>Powered by LINE × Cloudflare Workers</span>
      </div>
    </footer>
  </div>

  <!-- 確認モーダル -->
  <div
    id="confirm-modal"
    class="fixed inset-0 z-40 hidden items-center justify-center bg-black/60"
  >
    <div class="w-full max-w-md rounded-2xl border border-slate-700 bg-slate-900 p-5 shadow-2xl shadow-black/60">
      <h2 class="mb-3 text-sm font-semibold text-slate-50">
        この内容で予約してよろしいですか？
      </h2>
      <div class="mb-3 space-y-1 rounded-xl border border-slate-700 bg-slate-950/70 p-3 text-xs text-slate-100">
        <div><span class="text-slate-400">日付：</span><span id="confirm-date"></span></div>
        <div><span class="text-slate-400">枠：</span><span id="confirm-slot"></span></div>
        <div><span class="text-slate-400">お名前：</span><span id="confirm-name"></span></div>
        <div><span class="text-slate-400">電話番号：</span><span id="confirm-phone"></span></div>
      </div>
      <p class="mb-4 text-[11px] text-slate-400">
        内容にお間違いがなければ「この内容で予約する」を押してください。
      </p>
      <div class="flex justify-end gap-2 text-[11px]">
        <button
          id="confirmNo"
          type="button"
          class="rounded-full border border-slate-600 bg-slate-900 px-3 py-1 text-[11px] font-medium text-slate-200 hover:bg-slate-800"
        >
          戻って修正する
        </button>
        <button
          id="confirmYes"
          type="button"
          class="rounded-full bg-gradient-to-r from-brand-gold via-amber-400 to-yellow-400 px-4 py-1.5 text-[11px] font-semibold text-slate-950 shadow-md shadow-amber-500/30 hover:brightness-105 active:scale-[0.98]"
        >
          この内容で予約する
        </button>
      </div>
    </div>
  </div>
  <!-- カレンダー追加セクション -->
    <!-- Calendar Section (styled v2) -->
    <section id="calendar-section" class="kb-card" style="display:none; margin-top:28px;">
    <div class="kb-header">
      <strong style="color:#334155;">カレンダーに追加する</strong>
    </div>
    <h2 class="kb-title">ご予約をカレンダーへ登録</h2>
    <p id="calendar-summary" class="kb-sub">
      日時・場所などの情報を、Google または Apple/他カレンダーに保存できます。
    </p>
    <div class="kb-actions">
      <button id="btn-google-calendar" type="button" class="kb-btn kb-btn-primary">
        Google カレンダーに追加
      </button>
      <button id="btn-ics-calendar" type="button" class="kb-btn kb-btn-ghost">
        Apple / 他カレンダー (.ics)
      </button>
    </div>
  </section>
<script>
  // 予約情報 → カレンダー用の日時文字列(YYYYMMDDTHHmmssZ)に整形
  function toCalTime(iso) {
    const d = new Date(iso);
    const pad = (n) => String(n).padStart(2, "0");
    const yyyy = d.getUTCFullYear();
    const mm   = pad(d.getUTCMonth() + 1);
    const dd   = pad(d.getUTCDate());
    const hh   = pad(d.getUTCHours());
    const mi   = pad(d.getUTCMinutes());
    const ss   = pad(d.getUTCSeconds());
    return `${yyyy}${mm}${dd}T${hh}${mi}${ss}Z`;
  }

  function buildGoogleCalendarUrl(info) {
    const start = toCalTime(info.start);
    const end   = toCalTime(info.end);
    const text  = encodeURIComponent(info.title || "ご予約");
    const details = encodeURIComponent(info.description || "");
    const params =
      `action=TEMPLATE&text=${text}&dates=${start}/${end}&details=${details}`;
    return `https://www.google.com/calendar/render?${params}`;
  }

  function downloadIcs(info) {
    const start = toCalTime(info.start);
    const end   = toCalTime(info.end);
    const uid   = `booking-${Date.now()}@kazukigroup.org`;
    const now   = toCalTime(new Date().toISOString());

    const esc = (s) =>
      String(s || "").replace(/\\n/g, "\\n").replace(/,/g, "\\,");
    const title = esc(info.title || "ご予約");
    const desc  = esc(info.description || "");

    const icsLines = [
      "BEGIN:VCALENDAR",
      "VERSION:2.0",
      "PRODID:-//Kazuki Group//Booking//JP",
      "CALSCALE:GREGORIAN",
      "BEGIN:VEVENT",
      `UID:${uid}`,
      `DTSTAMP:${now}`,
      `DTSTART:${start}`,
      `DTEND:${end}`,
      `SUMMARY:${title}`,
      `DESCRIPTION:${desc}`,
      "END:VEVENT",
      "END:VCALENDAR"
    ];

    const blob = new Blob([icsLines.join("\\r\\n")], {
      type: "text/calendar;charset=utf-8",
    });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "reservation.ics";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // 予約完了後に呼び出すエントリポイント
  // info: { start, end, label, name, slotId }
  window.showCalendarOptions = function (info) {
    const section = document.getElementById("calendar-section");
    const summary = document.getElementById("calendar-summary");
    const btnG    = document.getElementById("btn-google-calendar");
    const btnIcs  = document.getElementById("btn-ics-calendar");
    if (!section || !summary || !btnG || !btnIcs) return;

    const label = info.label || "";
    const name  = info.name || "";
    const baseTitle = name ? `${name} さんのご予約` : "ご予約";
    const title = label ? `${baseTitle}（${label}）` : baseTitle;

    summary.textContent = label
      ? `「${label}」の予約をカレンダーに登録できます。`
      : "予約内容をカレンダーに登録できます。";

    const payload = {
      start: info.start,
      end: info.end,
      title,
      description: `Slot: ${info.slotId || ""}`,
    };

    btnG.onclick = () => {
      const url = buildGoogleCalendarUrl(payload);
      window.open(url, "_blank", "noopener");
    };

    btnIcs.onclick = () => {
      downloadIcs(payload);
    };

    section.style.display = "block";
  };
</script>
<script>
(() => {
  if (window.__reserveHookInstalled) return;  // 二重防止
  window.__reserveHookInstalled = true;

  // fetchフック: /line/reserve の成功レスポンスを捕捉
  const _fetch = window.fetch.bind(window);
  window.fetch = async (input, init) => {
    const url = (typeof input === "string") ? input : (input?.url || "");
    // POST body を拾う（slotId を取りたい）
    let bodyJson = {};
    try {
      const raw = init?.body;
      if (typeof raw === "string") bodyJson = JSON.parse(raw);
    } catch {}

    const res = await _fetch(input, init);

    try {
      if (url.includes("/line/reserve") && res.ok) {
        // 名前はフォームから取得
        const name = (document.getElementById("name")?.value || "").trim();

        // 1) まずは既存の window.slots から検索（UIで保持している前提）
        let slots = (window.slots || []);
        // 2) 見つからなければ当日スロットを再取得
        if (!Array.isArray(slots) || slots.length === 0) {
          const date = (document.getElementById("date")?.value || "");
          const base = (window.API_BASE || (new URL(location.href).searchParams.get("api") || "") || "");
          const api  = base && base.startsWith("http") ? base : (window.API_BASE || "");
          if (api && date) {
            const r = await _fetch(`${api}/line/slots?date=${encodeURIComponent(date)}`);
            const j = await r.json().catch(() => ({}));
            if (Array.isArray(j?.slots)) slots = j.slots;
          }
        }

        const sid = bodyJson?.slotId;
        const sel = Array.isArray(slots) ? slots.find(s => s?.id === sid) : null;

        if (sel && typeof window.showCalendarOptions === "function") {
          window.showCalendarOptions({
            start: sel.start,
            end: sel.end,
            label: sel.label || "",
            name,
            slotId: sel.id
          });
          // デバッグ用に保持
          window.__calendarInfo = { start: sel.start, end: sel.end, label: sel.label, name, slotId: sel.id };
        } else {
          console.warn("calendar hook: slot or function not found", {sid, hasFn: typeof window.showCalendarOptions});
        }
      }
    } catch (e) {
      console.warn("calendar hook error:", e);
    }

    return res;
  };
})();
</script>
<script>
(() => {
  // 二重適用ガード
  if (window.__calendarButtonsWired) return;
  window.__calendarButtonsWired = true;

  // 共通: Google/ICS の実行関数
  function toCalTime(iso) {
    const d = new Date(iso);
    const pad = (n) => String(n).padStart(2,"0");
    return `${d.getUTCFullYear()}${pad(d.getUTCMonth()+1)}${pad(d.getUTCDate())}T${pad(d.getUTCHours())}${pad(d.getUTCMinutes())}${pad(d.getUTCSeconds())}Z`;
  }
  function buildGoogleCalendarUrl(info){
    const start = toCalTime(info.start), end = toCalTime(info.end);
    const text  = encodeURIComponent(info.title || "ご予約");
    const details = encodeURIComponent(info.description || "");
    return `https://www.google.com/calendar/render?action=TEMPLATE&text=${text}&dates=${start}/${end}&details=${details}`;
  }
  function downloadIcs(info){
    const start = toCalTime(info.start), end = toCalTime(info.end);
    const uid = `booking-${Date.now()}@kazukigroup.org`;
    const now = toCalTime(new Date().toISOString());
    const esc = (s)=> String(s||"").replace(/\n/g,"\\n").replace(/,/g,"\\,");
    const ics = [
      "BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//Kazuki Group//Booking//JP","CALSCALE:GREGORIAN",
      "BEGIN:VEVENT",`UID:${uid}`,`DTSTAMP:${now}`,`DTSTART:${start}`,`DTEND:${end}`,
      `SUMMARY:${esc(info.title||"ご予約")}`,`DESCRIPTION:${esc(info.description||"")}`,
      "END:VEVENT","END:VCALENDAR"
    ].join("\r\n");
    const blob = new Blob([ics], {type:"text/calendar;charset=utf-8"});
    const url = URL.createObjectURL(blob); const a = document.createElement("a");
    a.href = url; a.download = "reservation.ics"; document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  // 予約情報の取得ロジック（__calendarInfo > window.slots > API再取得）
  async function getLatestReservationInfo(){
    // 1) 予約直後にフックが入れてくれるデータ
    if (window.__calendarInfo) return window.__calendarInfo;

    // 2) 表示中スロットから推定（最初のスロットを暫定利用）
    let slots = Array.isArray(window.slots) ? window.slots : [];
    if (!slots.length) {
      const date = (document.getElementById("date")?.value || "");
      const base = (window.API_BASE || (new URL(location.href).searchParams.get("api") || "") || "");
      const api  = base && base.startsWith("http") ? base : (window.API_BASE || "");
      if (api && date) {
        try {
          const r = await fetch(`${api}/line/slots?date=${encodeURIComponent(date)}`);
          const j = await r.json(); if (Array.isArray(j?.slots)) slots = j.slots;
        } catch(e) { console.warn("fetch slots failed", e); }
      }
    }
    if (!slots.length) throw new Error("スロット情報が取得できませんでした");

    const name = (document.getElementById("name")?.value || "").trim();
    const sel  = slots[0]; // 最低限のフォールバック（本来は最後に予約したIDを使う）
    const info = { start: sel.start, end: sel.end, label: sel.label || "", name, slotId: sel.id };
    window.__calendarInfo = info; // キャッシュ
    return info;
  }

  function buildTitle(info){
    const base = info.name ? `${info.name} さんのご予約` : "ご予約";
    return info.label ? `${base}（${info.label}）` : base;
  }

  async function onClickGoogle(){
    try {
      const info = await getLatestReservationInfo();
      const payload = { start: info.start, end: info.end, title: buildTitle(info), description: `Slot: ${info.slotId||""}` };
      const url = buildGoogleCalendarUrl(payload);
      window.open(url, "_blank", "noopener");
    } catch(e) { alert("カレンダー情報の準備に失敗しました。もう一度お試しください。"); console.warn(e); }
  }
  async function onClickIcs(){
    try {
      const info = await getLatestReservationInfo();
      const payload = { start: info.start, end: info.end, title: buildTitle(info), description: `Slot: ${info.slotId||""}` };
      downloadIcs(payload);
    } catch(e) { alert("カレンダー情報の準備に失敗しました。もう一度お試しください。"); console.warn(e); }
  }

  function wire(){
    const g = document.getElementById("btn-google-calendar");
    const i = document.getElementById("btn-ics-calendar");
    if (g && !g.__wired){ g.addEventListener("click", onClickGoogle); g.__wired = true; }
    if (i && !i.__wired){ i.addEventListener("click", onClickIcs); i.__wired = true; }
  }

  // 初回 & DOM更新対策
  document.addEventListener("DOMContentLoaded", wire);
  setInterval(wire, 1000); // 完了カードが後から表示されても確実に接続
})();
</script><div style="margin-top:6px">
    <button id="dbg-log"   class="ok"/button>
    <button id="dbg-gcal"  class="warn"/button>
    <button id="dbg-ics"   class="warn"/button>
  </div>
  <div id="dbg-meta" style="margin-top:6px; opacity:.8"></div>
</div>
<script>
(() => {
  const E = (id)=>document.getElementById(id);
  const status = E('dbg-status'); const meta = E('dbg-meta');

  function setStatus(t){ status.textContent = t; }
  function safeTitle(info){
    const base = info?.name ? `${info.name} さんのご予約` : 'ご予約';
    return info?.label ? `${base}（${info.label}）` : base;
  }
  function pad(n){ return String(n).padStart(2,'0'); }
  function toCalTime(iso){
    const d=new Date(iso);
    return `${d.getUTCFullYear()}${pad(d.getUTCMonth()+1)}${pad(d.getUTCDate())}T${pad(d.getUTCHours())}${pad(d.getUTCMinutes())}${pad(d.getUTCSeconds())}Z`;
  }
  function gcalURL(info){
    const start=toCalTime(info.start), end=toCalTime(info.end);
    const text=encodeURIComponent(safeTitle(info)); const details=encodeURIComponent(info.description||'');
    return `https://www.google.com/calendar/render?action=TEMPLATE&text=${text}&dates=${start}/${end}&details=${details}`;
  }
  function icsDL(info){
    const start=toCalTime(info.start), end=toCalTime(info.end);
    const now = toCalTime(new Date().toISOString());
    const uid = `booking-${Date.now()}@kazukigroup.org`;
    const esc=(s)=>String(s||'').replace(/\n/g,'\\n').replace(/,/g,'\\,');
    const ics=[
      "BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//Kazuki Group//Booking//JP","CALSCALE:GREGORIAN",
      "BEGIN:VEVENT",`UID:${uid}`,`DTSTAMP:${now}`,`DTSTART:${start}`,`DTEND:${end}`,
      `SUMMARY:${esc(safeTitle(info))}`,`DESCRIPTION:${esc(info.description||'')}`,
      "END:VEVENT","END:VCALENDAR"
    ].join("\\r\\n");
    const url=URL.createObjectURL(new Blob([ics],{type:"text/calendar;charset=utf-8"}));
    const a=document.createElement('a'); a.href=url; a.download='reservation.ics';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  async function getInfo(){
    if (window.__calendarInfo) return window.__calendarInfo;
    let slots = Array.isArray(window.slots)?window.slots:[];
    if (!slots.length) {
      const date=document.getElementById('date')?.value||'';
      const base = (window.API_BASE || (new URL(location.href).searchParams.get('api') || '') || '');
      const api  = base && base.startsWith('http') ? base : (window.API_BASE || '');
      if (api && date){
        try { const r=await fetch(`${api}/line/slots?date=${encodeURIComponent(date)}`);
          const j=await r.json(); if (Array.isArray(j?.slots)) slots=j.slots;
        } catch(e){ console.warn('fetch slots failed', e); }
      }
    }
    if (!slots.length) throw new Error('slotsが取れない');
    const name=document.getElementById('name')?.value||'';
    const sel=slots[0]; const info={start:sel.start,end:sel.end,label:sel.label||'',name,slotId:sel.id};
    window.__calendarInfo = info; return info;
  }

  function renderMeta() {
    meta.innerHTML = [
      `API_BASE: <code>${window.API_BASE||'(none)'}</code>`,
      `slots: <code>${Array.isArray(window.slots)?window.slots.length:0}</code>`,
      `has showCalendarOptions: <code>${typeof window.showCalendarOptions}</code>`,
      `has fetch hook: <code>${window.__reserveHookInstalled? 'yes':'no'}</code>`
    ].join('<br/>');
  }

  E('dbg-log').onclick = async () => {
    try {
      const info = await getInfo();
      console.log('[CAL-DBG] info=', info, 'slots=', window.slots);
      alert(`OK: ${safeTitle(info)}\nstart=${info.start}\nend=${info.end}`);
      setStatus('ok: info ready');
      renderMeta();
    } catch(e){
      console.warn(e); alert('NG: 情報取得に失敗（Console参照）'); setStatus('error: info missing'); renderMeta();
    }
  };

  E('dbg-gcal').onclick = async () => {
    try {
      const info = await getInfo();
      const w = window.open(gcalURL({...info, description:`Slot: ${info.slotId||''}`}), '_blank', 'noopener');
      if (!w) alert('ポップアップがブロックされています。サイトのポップアップを許可して再実行してね。');
      setStatus('try: google');
    } catch(e){ console.warn(e); alert('Google起動に失敗'); setStatus('error: google'); }
  };

  E('dbg-ics').onclick = async () => {
    try {
      const info = await getInfo(); icsDL({...info, description:`Slot: ${info.slotId||''}`});
      setStatus('try: ics');
    } catch(e){ console.warn(e); alert('ICS生成に失敗'); setStatus('error: ics'); }
  };

  renderMeta(); setStatus('ready');
})();
</script>
<script>
(() => {
  const btn = document.querySelector('button, input[type=button], #btn-load-slots');
  if (!btn) return;
  btn.addEventListener('click', async () => {
    const date = document.getElementById('date')?.value;
    if (!date || !window.API_BASE) return alert('日付またはAPI_BASEが未設定です');
    try {
      const res = await fetch(${window.API_BASE}/line/slots?date=);
      const j = await res.json();
      if (Array.isArray(j?.slots)) {
        window.slots = j.slots;
        console.log('✅ slots loaded', j.slots);
        alert(空き枠  件を取得しました);
      } else {
        alert('⚠️ 空き枠が取得できませんでした');
      }
    } catch (e) {
      console.error('slot fetch error', e);
      alert('⚠️ スロット取得に失敗しました');
    }
  });
})();
</script>
<!-- AUTO-SLOTS INIT (injected) -->
<script>
(() => {
  if (window.__autoSlotsInitInstalled) return;
  window.__autoSlotsInitInstalled = true;

  // 1) API_BASE 既定値（prod をデフォルトに）
  //    すでに window.API_BASE があれば上書きしない
  window.API_BASE = window.API_BASE || "https://saas-api-v4.hekuijincun.workers.dev";

  // 2) 日付の yyyy-MM-dd を返す
  const fmt = (d) => {
    const p = (n)=>String(n).padStart(2,"0");
    return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`;
  };

  // 3) 当日 or 入力済みの日付を決定
  function resolveDate() {
    const el = document.getElementById("date");
    const v  = (el && el.value || "").trim();
    if (v) return v;
    return fmt(new Date());
  }

  // 4) slots を API から取得して window.slots に格納（可視UIは触らない）
  async function loadSlotsOnce() {
    try {
      const api  = window.API_BASE;
      if (!api || !api.startsWith("http")) {
        console.warn("[auto-slots] invalid API_BASE:", api);
        return;
      }
      const date = resolveDate();
      const r = await fetch(`${api}/line/slots?date=${encodeURIComponent(date)}`);
      const j = await r.json().catch(()=> ({}));
      if (Array.isArray(j?.slots)) {
        window.slots = j.slots;
        // デバッグパネルがあれば更新されるようにイベント投げる（任意）
        window.dispatchEvent(new Event("auto-slots-ready"));
        console.log("[auto-slots] loaded", { date, count: j.slots.length });
      } else {
        console.warn("[auto-slots] slots not array", j);
      }
    } catch (e) {
      console.warn("[auto-slots] failed", e);
    }
  }

  // 5) DOM 準備できたら一度だけ読み込み
  document.addEventListener("DOMContentLoaded", () => {
    // date 未入力なら当日をセット（UIが #date を持っていれば）
    const el = document.getElementById("date");
    if (el && !el.value) {
      el.value = fmt(new Date());
    }
    loadSlotsOnce();
  });

  // 6) 日付変更時にも再取得（#date があれば）
  document.addEventListener("change", (ev) => {
    const t = ev.target;
    if (t && t.id === "date") {
      loadSlotsOnce();
    }
  });
})();
</script>
<!-- POPUP-GESTURE FIX (injected) -->
<script>
(() => {
  if (window.__popupGestureFixInstalled) return;
  window.__popupGestureFixInstalled = true;

  // 既存のユーティリティに依存（無ければ最小限を定義）
  const pad = (n)=>String(n).padStart(2,'0');
  const toCalTime = (iso)=>{ const d=new Date(iso);
    return `${d.getUTCFullYear()}${pad(d.getUTCMonth()+1)}${pad(d.getUTCDate())}T${pad(d.getUTCHours())}${pad(d.getUTCMinutes())}${pad(d.getUTCSeconds())}Z`; };
  const buildTitle = (info) => {
    const base = info?.name ? `${info.name} さんのご予約` : 'ご予約';
    return info?.label ? `${base}（${info.label}）` : base;
  };
  const buildGoogleCalendarUrl = (info) => {
    const start = toCalTime(info.start), end = toCalTime(info.end);
    const text  = encodeURIComponent(info.title || 'ご予約');
    const details = encodeURIComponent(info.description || '');
    return `https://www.google.com/calendar/render?action=TEMPLATE&text=${text}&dates=${start}/${end}&details=${details}`;
  };
  async function getLatestReservationInfo(){
    if (window.__calendarInfo) return window.__calendarInfo;
    let slots = Array.isArray(window.slots) ? window.slots : [];
    if (!slots.length) {
      const date = (document.getElementById('date')?.value||'');
      const api  = window.API_BASE;
      if (api && date) {
        try { const r = await fetch(`${api}/line/slots?date=${encodeURIComponent(date)}`);
          const j = await r.json(); if (Array.isArray(j?.slots)) slots = j.slots;
        } catch(e) { console.warn('fetch slots failed', e); }
      }
    }
    if (!slots.length) throw new Error('slots empty');
    const name = (document.getElementById('name')?.value||'').trim();
    const sel  = slots[0];
    const info = { start: sel.start, end: sel.end, label: sel.label||'', name, slotId: sel.id };
    window.__calendarInfo = info;
    return info;
  }

  // 🔑 ポイント: クリック直後にタブを開いて“ユーザー操作の文脈”を確保
  async function openGCalSafely(){
    // 1) 先に空タブ
    const w = window.open('about:blank', '_blank', 'noopener');
    if (!w) { alert('ポップアップがブロックされています。許可してもう一度。'); return; }
    try {
      const info = await getLatestReservationInfo();
      const payload = { start: info.start, end: info.end, title: buildTitle(info), description: `Slot: ${info.slotId||''}` };
      const url = buildGoogleCalendarUrl(payload);
      // 2) 空タブに遷移
      w.location = url;
    } catch (e) {
      console.warn('openGCalSafely failed', e);
      w.close();
      alert('Google起動に失敗');
    }
  }

  function downloadIcsSafe(){
    // ICS は popup ブロックにかかりにくいが、念のためユーザー操作直後に生成
    (async () => {
      try {
        const info = await getLatestReservationInfo();
        const start = toCalTime(info.start), end = toCalTime(info.end);
        const uid = `booking-${Date.now()}@kazukigroup.org`;
        const now = toCalTime(new Date().toISOString());
        const esc = (s)=> String(s||'').replace(/\n/g,'\\n').replace(/,/g,'\\,');
        const ics = [
          "BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//Kazuki Group//Booking//JP","CALSCALE:GREGORIAN",
          "BEGIN:VEVENT",`UID:${uid}`,`DTSTAMP:${now}`,`DTSTART:${start}`,`DTEND:${end}`,
          `SUMMARY:${esc(buildTitle(info))}`,`DESCRIPTION:${esc(`Slot: ${info.slotId||''}`)}`,
          "END:VEVENT","END:VCALENDAR"
        ].join("\\r\\n");
        const blob = new Blob([ics], {type:"text/calendar;charset=utf-8"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'reservation.ics';
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      } catch(e) {
        console.warn('ICS failed', e);
        alert('ICS生成に失敗');
      }
    })();
  }

  // 既存ボタンへ再配線（毎秒チェックで動的DOMにも追従）
  function wire(){
    const g = document.getElementById('btn-google-calendar');
    const i = document.getElementById('btn-ics-calendar');
    if (g && !g.__wiredFix){ g.addEventListener('click', openGCalSafely); g.__wiredFix = true; }
    if (i && !i.__wiredFix){ i.addEventListener('click', downloadIcsSafe); i.__wiredFix = true; }
  }
  document.addEventListener('DOMContentLoaded', wire);
  setInterval(wire, 800);
})();
</script>
<!-- CALENDAR POLISH (injected) -->
<script>
(() => {
  if (window.__calendarPolishInstalled) return;
  window.__calendarPolishInstalled = true;

  // === カスタマイズここから ===
  const ORG_NAME   = "Kazuki Group";
  const ORG_EMAIL  = "noreply@kazukigroup.org";     // 任意（ICS ORGANIZER 表示用）
  const PLACE_TEXT = "Kazuki Group（東京都○○区○○1-2-3）"; // 住所 or 店舗名
  const PLACE_URL  = "https://kazukigroup.org";     // 店舗URL/LP
  const CANCEL_URL_BASE = "https://kazukigroup.org/cancel?id="; // 予約IDを連結（例）
  // === カスタマイズここまで ===

  // 既存の title ロジックを尊重
  const pad = (n)=>String(n).padStart(2,"0");
  const toCalTime = (iso)=>{ const d=new Date(iso);
    return `${d.getUTCFullYear()}${pad(d.getUTCMonth()+1)}${pad(d.getUTCDate())}T${pad(d.getUTCHours())}${pad(d.getUTCMinutes())}${pad(d.getUTCSeconds())}Z`; };
  const buildTitle = (info) => {
    const base = info?.name ? `${info.name} さんのご予約` : 'ご予約';
    return info?.label ? `${base}（${info.label}）` : base;
  };

  // Google カレンダー URL（location 追加版）
  window.buildGoogleCalendarUrl = function(info) {
    const start = toCalTime(info.start), end = toCalTime(info.end);
    const text  = encodeURIComponent(info.title || 'ご予約');
    const details = encodeURIComponent(info.description || '');
    const loc  = encodeURIComponent(PLACE_TEXT);
    // location パラメータを追加
    return `https://www.google.com/calendar/render?action=TEMPLATE&text=${text}&dates=${start}/${end}&details=${details}&location=${loc}`;
  };

  // ICS 生成（LOCATION/URL/STATUS/ORGANIZER/TRANSP を追加）
  window.downloadIcs = function(info){
    const start = toCalTime(info.start), end = toCalTime(info.end);
    const uid = `booking-${Date.now()}@kazukigroup.org`;
    const now = toCalTime(new Date().toISOString());
    const esc=(s)=>String(s||'').replace(/\r?\n/g,'\\n').replace(/,/g,'\\,');
    const ics = [
      "BEGIN:VCALENDAR",
      "VERSION:2.0",
      "PRODID:-//Kazuki Group//Booking//JP",
      "CALSCALE:GREGORIAN",
      "METHOD:PUBLISH",
      "BEGIN:VEVENT",
      `UID:${uid}`,
      `DTSTAMP:${now}`,
      `DTSTART:${start}`,
      `DTEND:${end}`,
      `SUMMARY:${esc(info.title||'ご予約')}`,
      `DESCRIPTION:${esc(info.description||'')}`,
      `LOCATION:${esc(PLACE_TEXT)}`,
      `URL:${PLACE_URL}`,
      "STATUS:CONFIRMED",
      "TRANSP:OPAQUE",
      `ORGANIZER;CN=${esc(ORG_NAME)}:mailto:${ORG_EMAIL}`,
      "END:VEVENT",
      "END:VCALENDAR"
    ].join("\\r\\n");
    const blob = new Blob([ics], {type:"text/calendar;charset=utf-8"});
    const url  = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'reservation.ics';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  };

  // showCalendarOptions の payload を拡張（description にリッチ情報）
  const _show = window.showCalendarOptions;
  window.showCalendarOptions = function(info){
    const reserveId = info?.slotId ? `S-${String(info.slotId).replace(/[^a-zA-Z0-9_-]/g,'')}` : '';
    const title = buildTitle(info);
    const details = [
      `予約ID: ${reserveId}`,
      `店舗: ${ORG_NAME}`,
      `場所: ${PLACE_TEXT}`,
      `Web: ${PLACE_URL}`,
      reserveId ? `キャンセル: ${CANCEL_URL_BASE}${reserveId}` : ''
    ].filter(Boolean).join("\\n");

    const payload = { start: info.start, end: info.end, title, description: details, slotId: info.slotId };

    // 既存UIのクリック処理を安全に張り替え
    const g = document.getElementById('btn-google-calendar');
    const i = document.getElementById('btn-ics-calendar');

    if (g && !g.__polished) {
      g.addEventListener('click', () => {
        try {
          // about:blank オープン → URL遷移（Popup対策）
          const w = window.open('about:blank','_blank','noopener'); 
          if (!w) { alert('ポップアップを許可してもう一度押してね。'); return; }
          w.location = window.buildGoogleCalendarUrl(payload);
        } catch { alert('Google起動に失敗'); }
      });
      g.__polished = true;
    }
    if (i && !i.__polished) {
      i.addEventListener('click', () => {
        try { window.downloadIcs(payload); } catch { alert('ICS生成に失敗'); }
      });
      i.__polished = true;
    }

    // 元の表示処理を維持
    try { if (typeof _show === 'function') _show(info); } catch {}
  };
})();
</script>
<script id="kb-pinpoint-brand-v3">
(() => {
  if (window.__kbPinpointBrandV3) return; window.__kbPinpointBrandV3 = true;

  function markSubtitle() {
    const header = document.querySelector("header") || document.body;
    // ヘッダー配下の要素を走査して "Online Booking" のノードを探す
    const walker = document.createTreeWalker(header, NodeFilter.SHOW_ELEMENT, null);
    let hit = false;
    while (walker.nextNode()) {
      const el = walker.currentNode;
      const txt = (el.textContent || "").trim();
      if (txt === "Online Booking") {
        el.classList.add("brand-subtitle","kb-muted");
        // 文字サイズ/行間を微調整（控えめ）
        el.style.fontWeight = "500";
        el.style.letterSpacing = ".2px";
        hit = true;
        break;
      }
    }
    // 念のためロゴ横の small っぽい要素も染める
    const smalls = document.querySelectorAll("header small, header .subtitle");
    smalls.forEach(s => s.classList.add("kb-muted","brand-subtitle"));
    return hit;
  }

  function grayMetaLines() {
    // 画面内の「API_BASE:」「slots:」「has fetch hook:」など情報行をグレー化
    const metas = Array.from(document.querySelectorAll("body *"))
      .filter(el => {
        const t = (el.textContent || "").trim();
        return /^API_BASE\s*:|^slots\s*:|^has\s+showCalendarOptions|^has\s+fetch\s+hook/i.test(t);
      });
    metas.forEach(el => el.classList.add("kb-meta"));

    // デバッグ残骸のテキスト行（Log 状態 / Google 強制 / ICS 強制DL）は非表示
    const leftovers = Array.from(document.querySelectorAll("body *"))
      .filter(el => /^(Log 状態|Google 強制|ICS 強制DL)$/.test((el.textContent||"").trim()));
    leftovers.forEach(el => el.style.display = "none");
  }

  document.addEventListener("DOMContentLoaded", () => {
    markSubtitle();
    grayMetaLines();
  });
  // 動的に変わる場合に備えて数回だけリトライ
  let n=0, id=setInterval(() => { n++; markSubtitle(); grayMetaLines(); if (n>6) clearInterval(id); }, 500);
})();
</script>
<script id="kb-subtitle-tagger">
(() => {
  if (window.__kbSubtitleTagged) return; window.__kbSubtitleTagged = true;

  function markBrandSubtitle(){
    // ロゴ付近で "Online Booking" というテキストの要素を探して brand-subtitle を付与
    const candidates = Array.from(document.querySelectorAll('header * , .header * , body *'))
      .filter(el => el.childElementCount === 0 && (el.textContent || '').trim() === 'Online Booking');
    for (const el of candidates) { el.classList.add('brand-subtitle'); }
  }

  function markMetaBlocks(){
    // 画面内で "API_BASE:" を含む要素に meta-muted を付与（親も含めて落ち着いたグレーに）
    const all = Array.from(document.querySelectorAll('body *'));
    for (const el of all) {
      const t = (el.textContent || '').trim();
      if (!t) continue;
      if (t.startsWith('API_BASE:') || t.startsWith('slots:') || t.includes('has showCalendarOptions') || t.includes('has fetch hook')) {
        (el.closest('.meta') || el).classList.add('meta-muted');
      }
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    try { markBrandSubtitle(); markMetaBlocks(); } catch {}
  });
})();
</script>
<script id="kb-subtitle-gray-js-v3">
(() => {
  if (window.__kbSubtitlePatched) return; window.__kbSubtitlePatched = true;
  const mark = (el) => el && el.classList && el.classList.add('brand-subtitle');
  // ヘッダー配下で "Online Booking" と表示されている要素にclass付与
  const scan = () => {
    document.querySelectorAll('header *').forEach(el => {
      const t = (el.textContent || '').trim();
      if (t === 'Online Booking') mark(el);
    });
  };
  // 初回 & 遅延読み込み対策
  document.addEventListener('DOMContentLoaded', scan);
  setTimeout(scan, 300);
  setTimeout(scan, 1000);
})();
</script>
<script id="kb-header-gray-hook-v1">
(() => {
  if (window.__kbHeaderGray) return; window.__kbHeaderGray = true;
  const mark = el => el?.classList?.add('brand-subtitle');
  const scan = () => {
    document.querySelectorAll('header *').forEach(el=>{
      const t=(el.textContent||'').trim();
      if(t==='Online Booking') mark(el);
    });
  };
  document.addEventListener('DOMContentLoaded', scan);
  setTimeout(scan, 300); setTimeout(scan, 1200);
})();
</script>
<script id="kb-header-gray-extend-js-v2">
(() => {
  if (window.__kbHeaderGray2) return; window.__kbHeaderGray2 = true;
  const mark = el => el?.classList?.add('brand-subtitle');
  const scan = () => {
    document.querySelectorAll('header *').forEach(el=>{
      const t=(el.textContent||'').trim();
      if(t==='Online Booking') mark(el);
    });
  };
  document.addEventListener('DOMContentLoaded', scan);
  setTimeout(scan, 400);
})();
</script>
<script id="kb-header-fullgray-js-v3">
(() => {
  if (window.__kbHeaderFullGray) return;
  window.__kbHeaderFullGray = true;
  const mark = el => el?.classList?.add('brand-subtitle');
  const scan = () => {
    document.querySelectorAll('header *').forEach(el => {
      const t = (el.textContent || '').trim();
      if (t === 'Online Booking') mark(el);
    });
  };
  document.addEventListener('DOMContentLoaded', scan);
  setTimeout(scan, 500);
})();
</script>
<script id="kb-header-onlygray-js-v1">
(() => {
  if (window.__kbHeaderOnlyGray) return;
  window.__kbHeaderOnlyGray = true;

  const pickHeader = () =>
    document.querySelector('header, .site-header, .main-header, .header, .topbar, .navbar');

  const applyWrap = (h) => {
    if (!h) return;
    // 直上の親に上塗り（白帯の原因が親要素のとき対策）
    const p = h.parentElement;
    p && p.classList && p.classList.add('wrapper-header');  // CSS側で上塗り対象
    // 「Online Booking」要素を見つけて、落ち着いた色クラスを付与
    const subs = Array.from(h.querySelectorAll('*')).filter(el => (el.textContent||'').trim()==='Online Booking');
    subs.forEach(el => el.classList.add('brand-subtitle'));
  };

  const h = pickHeader();
  applyWrap(h);
  // SPA的に差し替わった場合も数回リトライ
  let tries = 0;
  const t = setInterval(() => {
    const hh = pickHeader();
    if (hh){ applyWrap(hh); tries++; if (tries>=5) clearInterval(t); }
  }, 400);
})();
</script>
</body>
</html>
