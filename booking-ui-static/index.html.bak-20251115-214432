<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Kazuki Booking | äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ </title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="Cache-Control" content="public, max-age=300" />
  <meta name="description" content="Kazuki Group ã®ã‚ªãƒ³ãƒ©ã‚¤ãƒ³äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ ã§ã™ã€‚" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              navy: '#0f172a',
              navySoft: '#111827',
              gold: '#facc15',
              accent: '#1d4ed8'
            }
          }
        }
      }
    };
  </script>

  <script>
    const fallback = "https://saas-api-v4.hekuijincun.workers.dev";
    const q = new URL(location.href).searchParams;
    const API_BASE =
      q.get("api") === "stg"
        ? "https://saas-api-staging-v4.hekuijincun.workers.dev"
        : (q.get("api") && q.get("api").startsWith("http"))
          ? q.get("api")
          : fallback;

    let selectedSlotId = null;
    let selectedSlotLabel = "";
    let slotsCache = [];

    function setQuickDate(kind) {
      const d = new Date();
      if (kind === "tomorrow") {
        d.setDate(d.getDate() + 1);
      } else if (kind === "weekend") {
        const day = d.getDay(); // 0:æ—¥ã€œ6:åœŸ
        let diff = (6 - day + 7) % 7;
        if (diff === 0) diff = 7; // æ¬¡ã®åœŸæ›œ
        d.setDate(d.getDate() + diff);
      }
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      const input = document.getElementById("date");
      input.value = yyyy + "-" + mm + "-" + dd;
    }

    async function loadSlots() {
      const dateInput = document.getElementById("date");
      const list = document.getElementById("slot-list");
      const msg = document.getElementById("system-message");

      selectedSlotId = null;
      selectedSlotLabel = "";
      list.innerHTML = "";
      msg.textContent = "";
      msg.className = "";

      const date = dateInput.value;
      if (!date) {
        msg.textContent = "æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚";
        msg.className = "text-sm text-red-400 mt-2";
        return;
      }

      const loading = document.getElementById("slots-loading");
      loading.classList.remove("hidden");

      try {
        const res = await fetch(API_BASE + "/line/slots?date=" + encodeURIComponent(date));
        if (!res.ok) throw new Error("ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰: " + res.status);
        const data = await res.json();
        slotsCache = data.slots || data || [];
        if (!Array.isArray(slotsCache) || slotsCache.length === 0) {
          list.innerHTML = '<p class="text-sm text-slate-300">ã“ã®æ—¥ä»˜ã®ç©ºãæ ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
          return;
        }

        list.innerHTML = "";
        slotsCache.forEach(slot => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className =
            "slot-card w-full text-left px-4 py-3 mb-2 rounded-xl border border-slate-700 bg-slate-900/80 hover:border-brand-gold hover:bg-slate-800 transition flex items-center justify-between";
          const id = slot.id || slot.slotId || "";
          const label = slot.label || slot.time || slot.startTime || "æ™‚é–“æœªè¨­å®š";
          const remain = (slot.remaining ?? slot.capacity ?? null);

          btn.dataset.slotId = id;
          btn.dataset.label = label;
          btn.dataset.remain = remain;

          let badgeHtml = "";
          if (remain !== null && remain !== undefined) {
            const isLow = Number(remain) <= 2;
            const badgeClass = isLow
              ? "bg-rose-500/10 text-rose-300 border-rose-400/70"
              : "bg-emerald-500/10 text-emerald-300 border-emerald-400/70";
            badgeHtml =
              '<span class="ml-3 inline-flex items-center rounded-full border ' +
              badgeClass +
              ' px-3 py-1 text-[11px] font-semibold">' +
              "æ®‹ã‚Š " + remain + " æ " +
              "</span>";
          }

          btn.innerHTML =
            '<div>' +
              '<div class="text-sm font-semibold text-slate-50">' + label + '</div>' +
              (remain !== null && remain !== undefined
                ? '<div class="text-xs text-slate-400 mt-0.5">æ—©ã‚ã®ã”äºˆç´„ã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚</div>'
                : "") +
            '</div>' +
            badgeHtml;

          btn.addEventListener("click", () => selectSlot(btn));
          list.appendChild(btn);
        });
      } catch (err) {
        console.error(err);
        msg.textContent = "ç©ºãæ ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å°‘ã—æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
        msg.className = "text-sm text-red-400 mt-2";
      } finally {
        loading.classList.add("hidden");
      }
    }

    function selectSlot(element) {
      selectedSlotId = element.dataset.slotId || null;
      selectedSlotLabel = element.dataset.label || "";
      document.querySelectorAll(".slot-card").forEach(el => {
        el.classList.remove("border-brand-gold", "ring-2", "ring-brand-gold/60");
      });
      element.classList.add("border-brand-gold", "ring-2", "ring-brand-gold/60");
      const msg = document.getElementById("system-message");
      msg.textContent = "é¸æŠä¸­ã®æ : " + (selectedSlotLabel || selectedSlotId || "ãªã—");
      msg.className = "text-sm text-brand-gold mt-2";
    }

    function openConfirmModal() {
      const dateInput = document.getElementById("date");
      const nameInput = document.getElementById("name");
      const phoneInput = document.getElementById("phone");
      const msg = document.getElementById("system-message");

      msg.textContent = "";
      msg.className = "";

      if (!dateInput.value) {
        msg.textContent = "æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚";
        msg.className = "text-sm text-red-400 mt-2";
        return;
      }
      if (!selectedSlotId) {
        msg.textContent = "äºˆç´„ã™ã‚‹æ ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚";
        msg.className = "text-sm text-red-400 mt-2";
        return;
      }
      if (!nameInput.value.trim()) {
        msg.textContent = "ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
        msg.className = "text-sm text-red-400 mt-2";
        return;
      }

      document.getElementById("confirm-date").textContent = dateInput.value;
      document.getElementById("confirm-slot").textContent = selectedSlotLabel || selectedSlotId;
      document.getElementById("confirm-name").textContent = nameInput.value.trim();
      document.getElementById("confirm-phone").textContent = phoneInput.value.trim() || "æœªå…¥åŠ›";

      const modal = document.getElementById("confirm-modal");
      modal.classList.remove("hidden");
    }

    async function doReserve() {
      const dateInput = document.getElementById("date");
      const nameInput = document.getElementById("name");
      const phoneInput = document.getElementById("phone");
      const msg = document.getElementById("system-message");

      const payload = {
        slotId: selectedSlotId,
        name: nameInput.value.trim(),
        phone: phoneInput.value.trim()
      };

      const reserveBtn = document.getElementById("reserveBtn");
      reserveBtn.disabled = true;
      reserveBtn.classList.add("opacity-60", "cursor-wait");

      try {
        const res = await fetch(API_BASE + "/line/reserve", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const text = await res.text();
        if (!res.ok) {
          throw new Error("äºˆç´„ã«å¤±æ•—ã—ã¾ã—ãŸ: " + res.status + " " + text);
        }

        msg.textContent = "äºˆç´„ãŒå®Œäº†ã—ã¾ã—ãŸã€‚LINEã‚’ã”ç¢ºèªãã ã•ã„ã€‚";
        msg.className = "text-sm text-emerald-400 mt-2";

        const success = document.getElementById("success-panel");
        success.classList.remove("hidden");
        success.classList.remove("opacity-0", "translate-y-4");
        success.classList.add("opacity-100", "translate-y-0");
      } catch (err) {
        console.error(err);
        msg.textContent = "äºˆç´„å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
        msg.className = "text-sm text-red-400 mt-2";
      } finally {
        reserveBtn.disabled = false;
        reserveBtn.classList.remove("opacity-60", "cursor-wait");
        closeConfirmModal();
      }
    }

    function closeConfirmModal() {
      const modal = document.getElementById("confirm-modal");
      modal.classList.add("hidden");
    }

    function initForm() {
      const d = document.getElementById("date");
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, "0");
      const dd = String(now.getDate()).padStart(2, "0");
      d.value = yyyy + "-" + mm + "-" + dd;
    }

    document.addEventListener("DOMContentLoaded", () => {
      initForm();
      document.getElementById("loadSlotsBtn").addEventListener("click", loadSlots);
      document.getElementById("reserveBtn").addEventListener("click", openConfirmModal);
      document.getElementById("confirmYes").addEventListener("click", doReserve);
      document.getElementById("confirmNo").addEventListener("click", closeConfirmModal);

      document.getElementById("tab-today").addEventListener("click", () => setQuickDate("today"));
      document.getElementById("tab-tomorrow").addEventListener("click", () => setQuickDate("tomorrow"));
      document.getElementById("tab-weekend").addEventListener("click", () => setQuickDate("weekend"));
    });
  </script>
  
<style id="kb-theme-light">
  :root{
    --kb-surface:#ffffff;
    --kb-surface-2:#f8fafc;      /* header/subtle èƒŒæ™¯ */
    --kb-border:#e5e7eb;
    --kb-text:#0f172a;           /* slate-900 */
    --kb-muted:#64748b;          /* slate-500 */
    --kb-brand:#2563eb;          /* blue-600 */
    --kb-brand-2:#60a5fa;        /* blue-400 */
    --kb-shadow:0 10px 30px rgba(15,23,42,.08);
    --kb-radius:16px;
  }

  /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã¿ãƒ©ã‚¤ãƒˆåŒ–ï¼ˆå…¨ä½“ã¸ã¯æ³¢åŠã—ãªã„ï¼‰ */
  #calendar-section.kb-card{
    color:var(--kb-text);
    background:var(--kb-surface);
    border:1px solid var(--kb-border);
    border-radius:var(--kb-radius);
    box-shadow:var(--kb-shadow);
  }
  #calendar-section .kb-title{
    margin:0 0 6px; font-size:18px; font-weight:700; letter-spacing:.01em;
  }
  #calendar-section .kb-sub{
    margin:0 0 14px; color:var(--kb-muted);
  }
  #calendar-section .kb-actions{
    display:flex; gap:12px; flex-wrap:wrap;
  }
  #calendar-section .kb-btn{
    padding:10px 16px; border-radius:999px; border:1px solid transparent;
    font-weight:700; cursor:pointer; transition:transform .05s ease, box-shadow .2s ease, opacity .2s ease;
  }
  #calendar-section .kb-btn:active{ transform:translateY(1px) }

  /* Primaryï¼ˆGoogleï¼‰: ãƒ–ãƒ«ãƒ¼ã‚°ãƒ©ãƒ‡ï¼‹æ·¡ã„ã‚·ãƒ£ãƒ‰ã‚¦ */
  #calendar-section .kb-btn-primary{
    color:#fff;
    background:linear-gradient(135deg, var(--kb-brand), var(--kb-brand-2));
    box-shadow:0 8px 24px rgba(37,99,235,.20);
  }
  #calendar-section .kb-btn-primary:hover{ opacity:.95 }

  /* Ghostï¼ˆICSï¼‰: ç™½èƒŒæ™¯ï¼‹ã‚°ãƒ¬ãƒ¼å¢ƒç•Œç·š */
  #calendar-section .kb-btn-ghost{
    color:var(--kb-text);
    background:var(--kb-surface);
    border-color:var(--kb-border);
  }
  #calendar-section .kb-btn-ghost:hover{
    border-color:#d1d5db; /* slate-300 */
    box-shadow:0 6px 16px rgba(2,6,23,.05);
  }

  /* å°ã•ãªã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼å¸¯ï¼ˆä»»æ„ã®ã‚¢ã‚¯ã‚»ãƒ³ãƒˆï¼‰ */
  #calendar-section .kb-header {
    background:var(--kb-surface-2);
    border:1px solid var(--kb-border);
    border-radius:12px;
    padding:10px 12px;
    margin:0 0 12px;
  }
</style>
  <style id="kb-force-light">
    /* ---- åŸºæœ¬é…è‰² ---- */
    body.kb-force-light, body.kb-force-light * {
      color-scheme: light !important;
    }
    body.kb-force-light{
      background:#fafafa !important;
      color:#0f172a !important; /* slate-900 */
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* ---- ã‚ˆãã‚ã‚‹æš—è‰²ã‚¯ãƒ©ã‚¹ã‚’å…¨é¢ãƒ©ã‚¤ãƒˆåŒ– ---- */
    body.kb-force-light .bg-slate-900,
    body.kb-force-light .bg-slate-900\/80,
    body.kb-force-light .bg-slate-800,
    body.kb-force-light .bg-slate-800\/80,
    body.kb-force-light [class*="bg-slate-9"],
    body.kb-force-light [class*="bg-slate-8"],
    body.kb-force-light [class*="bg-slate-7"],
    body.kb-force-light .border-slate-800,
    body.kb-force-light .border-slate-700 {
      background:#ffffff !important;
      border-color:#e5e7eb !important; /* gray-200 */
      color:#0f172a !important;
    }

    body.kb-force-light .text-slate-100,
    body.kb-force-light .text-slate-200,
    body.kb-force-light .text-slate-300,
    body.kb-force-light [class*="text-slate-1"],
    body.kb-force-light [class*="text-slate-2"],
    body.kb-force-light [class*="text-slate-3"]{
      color:#0f172a !important;
      opacity:0.92 !important;
    }

    /* ã‚«ãƒ¼ãƒ‰èª¿æ•´ */
    body.kb-force-light section,
    body.kb-force-light .card,
    body.kb-force-light .rounded-2xl,
    body.kb-force-light .rounded-xl{
      background:#ffffff !important;
      border:1px solid #e5e7eb !important;
      box-shadow:0 10px 24px rgba(15,23,42,.06) !important;
    }

    /* å…¥åŠ›ãƒ»ä¸€è¦§ã®èƒŒæ™¯ã‚’ç™½ã«å¯„ã›ã‚‹ */
    body.kb-force-light input,
    body.kb-force-light select,
    body.kb-force-light textarea,
    body.kb-force-light .list,
    body.kb-force-light .slot-card{
      background:#ffffff !important;
      color:#0f172a !important;
      border-color:#e5e7eb !important;
    }

    /* æˆåŠŸãƒ‘ãƒãƒ«ã¯æ·¡ã„ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ã§ */
    body.kb-force-light #success-panel{
      background:#ecfdf5 !important;            /* emerald-50 */
      border-color:#a7f3d0 !important;          /* emerald-200 */
      color:#064e3b !important;                 /* emerald-900 */
      box-shadow:0 8px 22px rgba(16,185,129,.15) !important;
    }

    /* ä¸»è¦ãƒœã‚¿ãƒ³ã¯ä¸Šè³ªãƒã‚¤ãƒ“ãƒ¼ */
    body.kb-force-light .btn-primary,
    body.kb-force-light button[type="submit"]{
      background:linear-gradient(135deg,#1f2a44,#2563eb) !important;
      color:#fff !important;
      border:0 !important;
      box-shadow:0 8px 22px rgba(37,99,235,.18) !important;
    }
    body.kb-force-light .btn-primary:hover,
    body.kb-force-light button[type="submit"]:hover{
      opacity:.96 !important;
    }

    /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®2ãƒœã‚¿ãƒ³ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰ */
    body.kb-force-light #btn-google-calendar{
      background:linear-gradient(135deg,#1f2a44,#2563eb) !important;
      color:#fff !important; border:0 !important; border-radius:999px !important;
      padding:10px 16px !important;
    }
    body.kb-force-light #btn-ics-calendar{
      background:#fff !important; color:#0f172a !important;
      border:1px solid #e5e7eb !important; border-radius:999px !important;
      padding:10px 16px !important;
    }
    body.kb-force-light #btn-ics-calendar:hover{
      background:#f3f4f6 !important; /* gray-100 */
    }

    /* ãƒ•ãƒƒã‚¿ãƒ¼ãƒ»èƒŒæ™¯ã®æ¿ƒè‰²æ®‹ã‚Šã‚’ç„¡åŠ›åŒ– */
    body.kb-force-light [style*="background:linear-gradient"][class*="bg-slate"],
    body.kb-force-light [class*="bg-"][style*="900"]{
      background:#ffffff !important;
    }
  </style>
</head>

<body class="kb-force-light min-h-screen bg-slate-950 text-slate-50">
  <div class="min-h-screen bg-gradient-to-b from-slate-950 via-slate-900 to-slate-950">
    <header class="border-b border-slate-800/80 bg-slate-950/80 backdrop-blur">
      <div class="mx-auto max-w-3xl px-4 py-4 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <div class="h-9 w-9 rounded-xl bg-gradient-to-br from-brand-gold to-amber-500 flex items-center justify-center shadow-lg shadow-amber-500/30">
            <span class="text-xs font-extrabold text-slate-950">KG</span>
          </div>
          <div>
            <div class="text-sm font-semibold tracking-wide text-slate-50">
              Kazuki Group
            </div>
            <div class="text-[11px] text-slate-400">Online Booking</div>
          </div>
        </div>
        <span class="inline-flex items-center rounded-full border border-slate-700/80 px-3 py-1 text-[11px] font-medium text-slate-300">
          <span class="h-1.5 w-1.5 rounded-full bg-emerald-400 mr-1.5 animate-pulse"></span>
          ç¨¼åƒä¸­
        </span>
      </div>
    </header>

    <main class="mx-auto max-w-3xl px-4 py-8">
      <div class="mb-6">
        <h1 class="text-2xl font-bold text-slate-50 tracking-tight">
          ã”äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ 
        </h1>
        <p class="mt-1 text-sm text-slate-400">
          æ—¥ä»˜ã¨ç©ºãæ ã‚’é¸æŠã—ã¦ã€ãŠåå‰ãƒ»é›»è©±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br />
          äºˆç´„å®Œäº†å¾Œã€LINEã«ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå±Šãã¾ã™ã€‚
        </p>
      </div>

      <div class="grid gap-6 lg:grid-cols-[minmax(0,2fr)_minmax(0,1.4fr)]">
        <section class="rounded-2xl border border-slate-800 bg-slate-900/70 p-5 shadow-xl shadow-black/40">
          <h2 class="mb-4 flex items-center gap-2 text-sm font-semibold text-slate-100">
            <span class="h-6 w-1 rounded-full bg-gradient-to-b from-brand-gold to-amber-500"></span>
            äºˆç´„å†…å®¹ã®å…¥åŠ›
          </h2>

          <div class="space-y-4">
            <div>
              <div class="grid gap-4 sm:grid-cols-2">
                <div>
                  <label for="date" class="mb-1 block text-xs font-medium text-slate-300">
                    æ—¥ä»˜<span class="ml-1 text-amber-400">*</span>
                  </label>
                  <input
                    id="date"
                    type="date"
                    class="w-full rounded-xl border border-slate-700 bg-slate-900/80 px-3 py-2 text-sm text-slate-50 shadow-inner shadow-black/40 focus:border-brand-gold focus:outline-none focus:ring-1 focus:ring-brand-gold/70"
                  />
                  <div class="mt-2 flex flex-wrap gap-2 text-[11px]">
                    <button
                      id="tab-today"
                      type="button"
                      class="rounded-full border border-slate-700 bg-slate-900/80 px-3 py-1 text-[11px] text-slate-200 hover:border-brand-gold/70 hover:bg-slate-800 transition"
                    >
                      ä»Šæ—¥
                    </button>
                    <button
                      id="tab-tomorrow"
                      type="button"
                      class="rounded-full border border-slate-700 bg-slate-900/80 px-3 py-1 text-[11px] text-slate-200 hover:border-brand-gold/70 hover:bg-slate-800 transition"
                    >
                      æ˜æ—¥
                    </button>
                    <button
                      id="tab-weekend"
                      type="button"
                      class="rounded-full border border-slate-700 bg-slate-900/80 px-3 py-1 text-[11px] text-slate-200 hover:border-brand-gold/70 hover:bg-slate-800 transition"
                    >
                      é€±æœ«
                    </button>
                  </div>
                </div>

                <div>
                  <label for="name" class="mb-1 block text-xs font-medium text-slate-300">
                    ãŠåå‰<span class="ml-1 text-amber-400">*</span>
                  </label>
                  <input
                    id="name"
                    placeholder="å±±ç”°å¤ªéƒ"
                    class="w-full rounded-xl border border-slate-700 bg-slate-900/80 px-3 py-2 text-sm text-slate-50 shadow-inner shadow-black/40 focus:border-brand-gold focus:outline-none focus:ring-1 focus:ring-brand-gold/70"
                  />
                </div>

                <div>
                  <label for="phone" class="mb-1 block text-xs font-medium text-slate-300">
                    é›»è©±ç•ªå·ï¼ˆä»»æ„ï¼‰
                  </label>
                  <input
                    id="phone"
                    placeholder="080-xxxx-xxxx"
                    class="w-full rounded-xl border border-slate-700 bg-slate-900/80 px-3 py-2 text-sm text-slate-50 shadow-inner shadow-black/40 focus:border-brand-gold focus:outline-none focus:ring-1 focus:ring-brand-gold/70"
                  />
                </div>
              </div>
            </div>

            <div class="flex items-center justify-between gap-3">
              <button
                id="loadSlotsBtn"
                type="button"
                class="inline-flex items-center gap-1.5 rounded-xl border border-slate-700 bg-slate-900/80 px-3 py-2 text-xs font-medium text-slate-100 hover:border-brand-gold/70 hover:bg-slate-800 transition"
              >
                <span class="h-1.5 w-1.5 rounded-full bg-slate-400"></span>
                ç©ºãæ ã‚’èª­ã¿è¾¼ã‚€
              </button>

              <button
                id="reserveBtn"
                type="button"
                class="inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-brand-gold via-amber-400 to-yellow-400 px-4 py-2 text-xs font-semibold text-slate-950 shadow-lg shadow-amber-500/40 hover:brightness-105 active:scale-[0.98] transition"
              >
                äºˆç´„ã‚’ç¢ºå®šã™ã‚‹
              </button>
            </div>

            <p id="system-message" class="text-sm text-slate-300 mt-1"></p>

            <div id="slots-loading" class="mt-2 hidden text-xs text-slate-400">
              èª­ã¿è¾¼ã¿ä¸­ã§ã™â€¦
            </div>

            <div class="mt-3 rounded-xl border border-slate-800 bg-slate-950/60 p-3">
              <h3 class="mb-2 text-xs font-semibold text-slate-200">
                ç©ºãæ ä¸€è¦§
              </h3>
              <div id="slot-list" class="max-h-60 space-y-1 overflow-y-auto">
                <p class="text-xs text-slate-500">
                  ã€Œç©ºãæ ã‚’èª­ã¿è¾¼ã‚€ã€ã‚’æŠ¼ã™ã¨ã€ã“ã®æ—¥ã«äºˆç´„å¯èƒ½ãªæ™‚é–“ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
                </p>
              </div>
            </div>
          </div>
        </section>

        <aside class="space-y-4">
          <section class="rounded-2xl border border-slate-800 bg-slate-900/80 p-4 shadow-xl shadow-black/40">
            <h2 class="mb-3 text-xs font-semibold text-slate-100">
              äºˆç´„ã®ãƒã‚¤ãƒ³ãƒˆ
            </h2>
            <ul class="space-y-2 text-xs text-slate-300">
              <li class="flex gap-2">
                <span class="mt-[3px] h-1.5 w-1.5 rounded-full bg-brand-gold"></span>
                <span>æ—¥ä»˜ã‚’é¸æŠã—ã¦ã‹ã‚‰ç©ºãæ ã‚’è¡¨ç¤ºã§ãã¾ã™ã€‚</span>
              </li>
              <li class="flex gap-2">
                <span class="mt-[3px] h-1.5 w-1.5 rounded-full bg-brand-gold"></span>
                <span>ãŠåå‰ã¯å¿…é ˆã§ã™ã€‚é›»è©±ç•ªå·ã¯æŠ˜ã‚Šè¿”ã—é€£çµ¡ãŒå¿…è¦ãªå ´åˆã«ä½¿ç”¨ã—ã¾ã™ã€‚</span>
              </li>
              <li class="flex gap-2">
                <span class="mt-[3px] h-1.5 w-1.5 rounded-full bg-brand-gold"></span>
                <span>äºˆç´„å®Œäº†å¾Œã€LINEã«ã¦è©³ç´°ã‚’ãŠé€ã‚Šã—ã¾ã™ã€‚</span>
              </li>
            </ul>
          </section>

          <section
            id="success-panel"
            class="hidden opacity-0 translate-y-4 rounded-2xl border border-emerald-500/40 bg-emerald-900/20 p-4 shadow-lg shadow-emerald-500/20 transition"
          >
            <h2 class="mb-1 text-xs font-semibold text-emerald-300">
              äºˆç´„ãŒå®Œäº†ã—ã¾ã—ãŸ
            </h2>
            <p class="text-xs text-emerald-100 mb-3">
              ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãŠé€ã‚Šã—ã¾ã—ãŸã®ã§ã€ã”ç¢ºèªãã ã•ã„ã€‚
            </p>
            <div class="flex flex-wrap gap-2 text-[11px]">
              <button
                type="button"
                class="rounded-full border border-emerald-400/70 bg-emerald-500/10 px-3 py-1 text-[11px] font-semibold text-emerald-100"
              >
                LINEã®ãƒˆãƒ¼ã‚¯ç”»é¢ã‚’é–‹ã„ã¦ç¢ºèªã™ã‚‹
              </button>
              <button
                type="button"
                class="rounded-full border border-slate-600 bg-slate-900/80 px-3 py-1 text-[11px] font-medium text-slate-200"
              >
                ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«äºˆå®šã¨ã—ã¦è¿½åŠ ã™ã‚‹ï¼ˆã”è‡ªèº«ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¢ãƒ—ãƒªã§ï¼‰
              </button>
            </div>
          </section>
        </aside>
      </div>
    </main>

    <footer class="mt-8 border-t border-slate-800/80 bg-slate-950/80">
      <div class="mx-auto max-w-3xl px-4 py-3 flex items-center justify-between text-[10px] text-slate-500">
        <span>Â© Kazuki Group</span>
        <span>Powered by LINE Ã— Cloudflare Workers</span>
      </div>
    </footer>
  </div>

  <!-- ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div
    id="confirm-modal"
    class="fixed inset-0 z-40 hidden items-center justify-center bg-black/60"
  >
    <div class="w-full max-w-md rounded-2xl border border-slate-700 bg-slate-900 p-5 shadow-2xl shadow-black/60">
      <h2 class="mb-3 text-sm font-semibold text-slate-50">
        ã“ã®å†…å®¹ã§äºˆç´„ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ
      </h2>
      <div class="mb-3 space-y-1 rounded-xl border border-slate-700 bg-slate-950/70 p-3 text-xs text-slate-100">
        <div><span class="text-slate-400">æ—¥ä»˜ï¼š</span><span id="confirm-date"></span></div>
        <div><span class="text-slate-400">æ ï¼š</span><span id="confirm-slot"></span></div>
        <div><span class="text-slate-400">ãŠåå‰ï¼š</span><span id="confirm-name"></span></div>
        <div><span class="text-slate-400">é›»è©±ç•ªå·ï¼š</span><span id="confirm-phone"></span></div>
      </div>
      <p class="mb-4 text-[11px] text-slate-400">
        å†…å®¹ã«ãŠé–“é•ã„ãŒãªã‘ã‚Œã°ã€Œã“ã®å†…å®¹ã§äºˆç´„ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚
      </p>
      <div class="flex justify-end gap-2 text-[11px]">
        <button
          id="confirmNo"
          type="button"
          class="rounded-full border border-slate-600 bg-slate-900 px-3 py-1 text-[11px] font-medium text-slate-200 hover:bg-slate-800"
        >
          æˆ»ã£ã¦ä¿®æ­£ã™ã‚‹
        </button>
        <button
          id="confirmYes"
          type="button"
          class="rounded-full bg-gradient-to-r from-brand-gold via-amber-400 to-yellow-400 px-4 py-1.5 text-[11px] font-semibold text-slate-950 shadow-md shadow-amber-500/30 hover:brightness-105 active:scale-[0.98]"
        >
          ã“ã®å†…å®¹ã§äºˆç´„ã™ã‚‹
        </button>
      </div>
    </div>
  </div>
  <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¿½åŠ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <!-- Calendar Section (styled v2) -->
    <section id="calendar-section" class="kb-card" style="display:none; margin-top:28px;">
    <div class="kb-header">
      <strong style="color:#334155;">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è¿½åŠ ã™ã‚‹</strong>
    </div>
    <h2 class="kb-title">ã”äºˆç´„ã‚’ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¸ç™»éŒ²</h2>
    <p id="calendar-summary" class="kb-sub">
      æ—¥æ™‚ãƒ»å ´æ‰€ãªã©ã®æƒ…å ±ã‚’ã€Google ã¾ãŸã¯ Apple/ä»–ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ä¿å­˜ã§ãã¾ã™ã€‚
    </p>
    <div class="kb-actions">
      <button id="btn-google-calendar" type="button" class="kb-btn kb-btn-primary">
        Google ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è¿½åŠ 
      </button>
      <button id="btn-ics-calendar" type="button" class="kb-btn kb-btn-ghost">
        Apple / ä»–ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ (.ics)
      </button>
    </div>
  </section>
<script>
  // äºˆç´„æƒ…å ± â†’ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”¨ã®æ—¥æ™‚æ–‡å­—åˆ—(YYYYMMDDTHHmmssZ)ã«æ•´å½¢
  function toCalTime(iso) {
    const d = new Date(iso);
    const pad = (n) => String(n).padStart(2, "0");
    const yyyy = d.getUTCFullYear();
    const mm   = pad(d.getUTCMonth() + 1);
    const dd   = pad(d.getUTCDate());
    const hh   = pad(d.getUTCHours());
    const mi   = pad(d.getUTCMinutes());
    const ss   = pad(d.getUTCSeconds());
    return `${yyyy}${mm}${dd}T${hh}${mi}${ss}Z`;
  }

  function buildGoogleCalendarUrl(info) {
    const start = toCalTime(info.start);
    const end   = toCalTime(info.end);
    const text  = encodeURIComponent(info.title || "ã”äºˆç´„");
    const details = encodeURIComponent(info.description || "");
    const params =
      `action=TEMPLATE&text=${text}&dates=${start}/${end}&details=${details}`;
    return `https://www.google.com/calendar/render?${params}`;
  }

  function downloadIcs(info) {
    const start = toCalTime(info.start);
    const end   = toCalTime(info.end);
    const uid   = `booking-${Date.now()}@kazukigroup.org`;
    const now   = toCalTime(new Date().toISOString());

    const esc = (s) =>
      String(s || "").replace(/\\n/g, "\\n").replace(/,/g, "\\,");
    const title = esc(info.title || "ã”äºˆç´„");
    const desc  = esc(info.description || "");

    const icsLines = [
      "BEGIN:VCALENDAR",
      "VERSION:2.0",
      "PRODID:-//Kazuki Group//Booking//JP",
      "CALSCALE:GREGORIAN",
      "BEGIN:VEVENT",
      `UID:${uid}`,
      `DTSTAMP:${now}`,
      `DTSTART:${start}`,
      `DTEND:${end}`,
      `SUMMARY:${title}`,
      `DESCRIPTION:${desc}`,
      "END:VEVENT",
      "END:VCALENDAR"
    ];

    const blob = new Blob([icsLines.join("\\r\\n")], {
      type: "text/calendar;charset=utf-8",
    });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "reservation.ics";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // äºˆç´„å®Œäº†å¾Œã«å‘¼ã³å‡ºã™ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ
  // info: { start, end, label, name, slotId }
  window.showCalendarOptions = function (info) {
    const section = document.getElementById("calendar-section");
    const summary = document.getElementById("calendar-summary");
    const btnG    = document.getElementById("btn-google-calendar");
    const btnIcs  = document.getElementById("btn-ics-calendar");
    if (!section || !summary || !btnG || !btnIcs) return;

    const label = info.label || "";
    const name  = info.name || "";
    const baseTitle = name ? `${name} ã•ã‚“ã®ã”äºˆç´„` : "ã”äºˆç´„";
    const title = label ? `${baseTitle}ï¼ˆ${label}ï¼‰` : baseTitle;

    summary.textContent = label
      ? `ã€Œ${label}ã€ã®äºˆç´„ã‚’ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ç™»éŒ²ã§ãã¾ã™ã€‚`
      : "äºˆç´„å†…å®¹ã‚’ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ç™»éŒ²ã§ãã¾ã™ã€‚";

    const payload = {
      start: info.start,
      end: info.end,
      title,
      description: `Slot: ${info.slotId || ""}`,
    };

    btnG.onclick = () => {
      const url = buildGoogleCalendarUrl(payload);
      window.open(url, "_blank", "noopener");
    };

    btnIcs.onclick = () => {
      downloadIcs(payload);
    };

    section.style.display = "block";
  };
</script>
<script>
(() => {
  if (window.__reserveHookInstalled) return;  // äºŒé‡é˜²æ­¢
  window.__reserveHookInstalled = true;

  // fetchãƒ•ãƒƒã‚¯: /line/reserve ã®æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æ•æ‰
  const _fetch = window.fetch.bind(window);
  window.fetch = async (input, init) => {
    const url = (typeof input === "string") ? input : (input?.url || "");
    // POST body ã‚’æ‹¾ã†ï¼ˆslotId ã‚’å–ã‚ŠãŸã„ï¼‰
    let bodyJson = {};
    try {
      const raw = init?.body;
      if (typeof raw === "string") bodyJson = JSON.parse(raw);
    } catch {}

    const res = await _fetch(input, init);

    try {
      if (url.includes("/line/reserve") && res.ok) {
        // åå‰ã¯ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰å–å¾—
        const name = (document.getElementById("name")?.value || "").trim();

        // 1) ã¾ãšã¯æ—¢å­˜ã® window.slots ã‹ã‚‰æ¤œç´¢ï¼ˆUIã§ä¿æŒã—ã¦ã„ã‚‹å‰æï¼‰
        let slots = (window.slots || []);
        // 2) è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°å½“æ—¥ã‚¹ãƒ­ãƒƒãƒˆã‚’å†å–å¾—
        if (!Array.isArray(slots) || slots.length === 0) {
          const date = (document.getElementById("date")?.value || "");
          const base = (window.API_BASE || (new URL(location.href).searchParams.get("api") || "") || "");
          const api  = base && base.startsWith("http") ? base : (window.API_BASE || "");
          if (api && date) {
            const r = await _fetch(`${api}/line/slots?date=${encodeURIComponent(date)}`);
            const j = await r.json().catch(() => ({}));
            if (Array.isArray(j?.slots)) slots = j.slots;
          }
        }

        const sid = bodyJson?.slotId;
        const sel = Array.isArray(slots) ? slots.find(s => s?.id === sid) : null;

        if (sel && typeof window.showCalendarOptions === "function") {
          window.showCalendarOptions({
            start: sel.start,
            end: sel.end,
            label: sel.label || "",
            name,
            slotId: sel.id
          });
          // ãƒ‡ãƒãƒƒã‚°ç”¨ã«ä¿æŒ
          window.__calendarInfo = { start: sel.start, end: sel.end, label: sel.label, name, slotId: sel.id };
        } else {
          console.warn("calendar hook: slot or function not found", {sid, hasFn: typeof window.showCalendarOptions});
        }
      }
    } catch (e) {
      console.warn("calendar hook error:", e);
    }

    return res;
  };
})();
</script>
<script>
(() => {
  // äºŒé‡é©ç”¨ã‚¬ãƒ¼ãƒ‰
  if (window.__calendarButtonsWired) return;
  window.__calendarButtonsWired = true;

  // å…±é€š: Google/ICS ã®å®Ÿè¡Œé–¢æ•°
  function toCalTime(iso) {
    const d = new Date(iso);
    const pad = (n) => String(n).padStart(2,"0");
    return `${d.getUTCFullYear()}${pad(d.getUTCMonth()+1)}${pad(d.getUTCDate())}T${pad(d.getUTCHours())}${pad(d.getUTCMinutes())}${pad(d.getUTCSeconds())}Z`;
  }
  function buildGoogleCalendarUrl(info){
    const start = toCalTime(info.start), end = toCalTime(info.end);
    const text  = encodeURIComponent(info.title || "ã”äºˆç´„");
    const details = encodeURIComponent(info.description || "");
    return `https://www.google.com/calendar/render?action=TEMPLATE&text=${text}&dates=${start}/${end}&details=${details}`;
  }
  function downloadIcs(info){
    const start = toCalTime(info.start), end = toCalTime(info.end);
    const uid = `booking-${Date.now()}@kazukigroup.org`;
    const now = toCalTime(new Date().toISOString());
    const esc = (s)=> String(s||"").replace(/\n/g,"\\n").replace(/,/g,"\\,");
    const ics = [
      "BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//Kazuki Group//Booking//JP","CALSCALE:GREGORIAN",
      "BEGIN:VEVENT",`UID:${uid}`,`DTSTAMP:${now}`,`DTSTART:${start}`,`DTEND:${end}`,
      `SUMMARY:${esc(info.title||"ã”äºˆç´„")}`,`DESCRIPTION:${esc(info.description||"")}`,
      "END:VEVENT","END:VCALENDAR"
    ].join("\r\n");
    const blob = new Blob([ics], {type:"text/calendar;charset=utf-8"});
    const url = URL.createObjectURL(blob); const a = document.createElement("a");
    a.href = url; a.download = "reservation.ics"; document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  // äºˆç´„æƒ…å ±ã®å–å¾—ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆ__calendarInfo > window.slots > APIå†å–å¾—ï¼‰
  async function getLatestReservationInfo(){
    // 1) äºˆç´„ç›´å¾Œã«ãƒ•ãƒƒã‚¯ãŒå…¥ã‚Œã¦ãã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿
    if (window.__calendarInfo) return window.__calendarInfo;

    // 2) è¡¨ç¤ºä¸­ã‚¹ãƒ­ãƒƒãƒˆã‹ã‚‰æ¨å®šï¼ˆæœ€åˆã®ã‚¹ãƒ­ãƒƒãƒˆã‚’æš«å®šåˆ©ç”¨ï¼‰
    let slots = Array.isArray(window.slots) ? window.slots : [];
    if (!slots.length) {
      const date = (document.getElementById("date")?.value || "");
      const base = (window.API_BASE || (new URL(location.href).searchParams.get("api") || "") || "");
      const api  = base && base.startsWith("http") ? base : (window.API_BASE || "");
      if (api && date) {
        try {
          const r = await fetch(`${api}/line/slots?date=${encodeURIComponent(date)}`);
          const j = await r.json(); if (Array.isArray(j?.slots)) slots = j.slots;
        } catch(e) { console.warn("fetch slots failed", e); }
      }
    }
    if (!slots.length) throw new Error("ã‚¹ãƒ­ãƒƒãƒˆæƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ");

    const name = (document.getElementById("name")?.value || "").trim();
    const sel  = slots[0]; // æœ€ä½é™ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆæœ¬æ¥ã¯æœ€å¾Œã«äºˆç´„ã—ãŸIDã‚’ä½¿ã†ï¼‰
    const info = { start: sel.start, end: sel.end, label: sel.label || "", name, slotId: sel.id };
    window.__calendarInfo = info; // ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    return info;
  }

  function buildTitle(info){
    const base = info.name ? `${info.name} ã•ã‚“ã®ã”äºˆç´„` : "ã”äºˆç´„";
    return info.label ? `${base}ï¼ˆ${info.label}ï¼‰` : base;
  }

  async function onClickGoogle(){
    try {
      const info = await getLatestReservationInfo();
      const payload = { start: info.start, end: info.end, title: buildTitle(info), description: `Slot: ${info.slotId||""}` };
      const url = buildGoogleCalendarUrl(payload);
      window.open(url, "_blank", "noopener");
    } catch(e) { alert("ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æƒ…å ±ã®æº–å‚™ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"); console.warn(e); }
  }
  async function onClickIcs(){
    try {
      const info = await getLatestReservationInfo();
      const payload = { start: info.start, end: info.end, title: buildTitle(info), description: `Slot: ${info.slotId||""}` };
      downloadIcs(payload);
    } catch(e) { alert("ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æƒ…å ±ã®æº–å‚™ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"); console.warn(e); }
  }

  function wire(){
    const g = document.getElementById("btn-google-calendar");
    const i = document.getElementById("btn-ics-calendar");
    if (g && !g.__wired){ g.addEventListener("click", onClickGoogle); g.__wired = true; }
    if (i && !i.__wired){ i.addEventListener("click", onClickIcs); i.__wired = true; }
  }

  // åˆå› & DOMæ›´æ–°å¯¾ç­–
  document.addEventListener("DOMContentLoaded", wire);
  setInterval(wire, 1000); // å®Œäº†ã‚«ãƒ¼ãƒ‰ãŒå¾Œã‹ã‚‰è¡¨ç¤ºã•ã‚Œã¦ã‚‚ç¢ºå®Ÿã«æ¥ç¶š
})();
</script><div style="margin-top:6px">
    <button id="dbg-log"   class="ok"/button>
    <button id="dbg-gcal"  class="warn"/button>
    <button id="dbg-ics"   class="warn"/button>
  </div>
  <div id="dbg-meta" style="margin-top:6px; opacity:.8"></div>
</div>
<script>
(() => {
  const E = (id)=>document.getElementById(id);
  const status = E('dbg-status'); const meta = E('dbg-meta');

  function setStatus(t){ status.textContent = t; }
  function safeTitle(info){
    const base = info?.name ? `${info.name} ã•ã‚“ã®ã”äºˆç´„` : 'ã”äºˆç´„';
    return info?.label ? `${base}ï¼ˆ${info.label}ï¼‰` : base;
  }
  function pad(n){ return String(n).padStart(2,'0'); }
  function toCalTime(iso){
    const d=new Date(iso);
    return `${d.getUTCFullYear()}${pad(d.getUTCMonth()+1)}${pad(d.getUTCDate())}T${pad(d.getUTCHours())}${pad(d.getUTCMinutes())}${pad(d.getUTCSeconds())}Z`;
  }
  function gcalURL(info){
    const start=toCalTime(info.start), end=toCalTime(info.end);
    const text=encodeURIComponent(safeTitle(info)); const details=encodeURIComponent(info.description||'');
    return `https://www.google.com/calendar/render?action=TEMPLATE&text=${text}&dates=${start}/${end}&details=${details}`;
  }
  function icsDL(info){
    const start=toCalTime(info.start), end=toCalTime(info.end);
    const now = toCalTime(new Date().toISOString());
    const uid = `booking-${Date.now()}@kazukigroup.org`;
    const esc=(s)=>String(s||'').replace(/\n/g,'\\n').replace(/,/g,'\\,');
    const ics=[
      "BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//Kazuki Group//Booking//JP","CALSCALE:GREGORIAN",
      "BEGIN:VEVENT",`UID:${uid}`,`DTSTAMP:${now}`,`DTSTART:${start}`,`DTEND:${end}`,
      `SUMMARY:${esc(safeTitle(info))}`,`DESCRIPTION:${esc(info.description||'')}`,
      "END:VEVENT","END:VCALENDAR"
    ].join("\\r\\n");
    const url=URL.createObjectURL(new Blob([ics],{type:"text/calendar;charset=utf-8"}));
    const a=document.createElement('a'); a.href=url; a.download='reservation.ics';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  async function getInfo(){
    if (window.__calendarInfo) return window.__calendarInfo;
    let slots = Array.isArray(window.slots)?window.slots:[];
    if (!slots.length) {
      const date=document.getElementById('date')?.value||'';
      const base = (window.API_BASE || (new URL(location.href).searchParams.get('api') || '') || '');
      const api  = base && base.startsWith('http') ? base : (window.API_BASE || '');
      if (api && date){
        try { const r=await fetch(`${api}/line/slots?date=${encodeURIComponent(date)}`);
          const j=await r.json(); if (Array.isArray(j?.slots)) slots=j.slots;
        } catch(e){ console.warn('fetch slots failed', e); }
      }
    }
    if (!slots.length) throw new Error('slotsãŒå–ã‚Œãªã„');
    const name=document.getElementById('name')?.value||'';
    const sel=slots[0]; const info={start:sel.start,end:sel.end,label:sel.label||'',name,slotId:sel.id};
    window.__calendarInfo = info; return info;
  }

  function renderMeta() {
    meta.innerHTML = [
      `API_BASE: <code>${window.API_BASE||'(none)'}</code>`,
      `slots: <code>${Array.isArray(window.slots)?window.slots.length:0}</code>`,
      `has showCalendarOptions: <code>${typeof window.showCalendarOptions}</code>`,
      `has fetch hook: <code>${window.__reserveHookInstalled? 'yes':'no'}</code>`
    ].join('<br/>');
  }

  E('dbg-log').onclick = async () => {
    try {
      const info = await getInfo();
      console.log('[CAL-DBG] info=', info, 'slots=', window.slots);
      alert(`OK: ${safeTitle(info)}\nstart=${info.start}\nend=${info.end}`);
      setStatus('ok: info ready');
      renderMeta();
    } catch(e){
      console.warn(e); alert('NG: æƒ…å ±å–å¾—ã«å¤±æ•—ï¼ˆConsoleå‚ç…§ï¼‰'); setStatus('error: info missing'); renderMeta();
    }
  };

  E('dbg-gcal').onclick = async () => {
    try {
      const info = await getInfo();
      const w = window.open(gcalURL({...info, description:`Slot: ${info.slotId||''}`}), '_blank', 'noopener');
      if (!w) alert('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚ã‚µã‚¤ãƒˆã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¨±å¯ã—ã¦å†å®Ÿè¡Œã—ã¦ã­ã€‚');
      setStatus('try: google');
    } catch(e){ console.warn(e); alert('Googleèµ·å‹•ã«å¤±æ•—'); setStatus('error: google'); }
  };

  E('dbg-ics').onclick = async () => {
    try {
      const info = await getInfo(); icsDL({...info, description:`Slot: ${info.slotId||''}`});
      setStatus('try: ics');
    } catch(e){ console.warn(e); alert('ICSç”Ÿæˆã«å¤±æ•—'); setStatus('error: ics'); }
  };

  renderMeta(); setStatus('ready');
})();
</script>
<script>
(() => {
  const btn = document.querySelector('button, input[type=button], #btn-load-slots');
  if (!btn) return;
  btn.addEventListener('click', async () => {
    const date = document.getElementById('date')?.value;
    if (!date || !window.API_BASE) return alert('æ—¥ä»˜ã¾ãŸã¯API_BASEãŒæœªè¨­å®šã§ã™');
    try {
      const res = await fetch(${window.API_BASE}/line/slots?date=);
      const j = await res.json();
      if (Array.isArray(j?.slots)) {
        window.slots = j.slots;
        console.log('âœ… slots loaded', j.slots);
        alert(ç©ºãæ   ä»¶ã‚’å–å¾—ã—ã¾ã—ãŸ);
      } else {
        alert('âš ï¸ ç©ºãæ ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
      }
    } catch (e) {
      console.error('slot fetch error', e);
      alert('âš ï¸ ã‚¹ãƒ­ãƒƒãƒˆå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  });
})();
</script>
<!-- AUTO-SLOTS INIT (injected) -->
<script>
(() => {
  if (window.__autoSlotsInitInstalled) return;
  window.__autoSlotsInitInstalled = true;

  // 1) API_BASE æ—¢å®šå€¤ï¼ˆprod ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ï¼‰
  //    ã™ã§ã« window.API_BASE ãŒã‚ã‚Œã°ä¸Šæ›¸ãã—ãªã„
  window.API_BASE = window.API_BASE || "https://saas-api-v4.hekuijincun.workers.dev";

  // 2) æ—¥ä»˜ã® yyyy-MM-dd ã‚’è¿”ã™
  const fmt = (d) => {
    const p = (n)=>String(n).padStart(2,"0");
    return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`;
  };

  // 3) å½“æ—¥ or å…¥åŠ›æ¸ˆã¿ã®æ—¥ä»˜ã‚’æ±ºå®š
  function resolveDate() {
    const el = document.getElementById("date");
    const v  = (el && el.value || "").trim();
    if (v) return v;
    return fmt(new Date());
  }

  // 4) slots ã‚’ API ã‹ã‚‰å–å¾—ã—ã¦ window.slots ã«æ ¼ç´ï¼ˆå¯è¦–UIã¯è§¦ã‚‰ãªã„ï¼‰
  async function loadSlotsOnce() {
    try {
      const api  = window.API_BASE;
      if (!api || !api.startsWith("http")) {
        console.warn("[auto-slots] invalid API_BASE:", api);
        return;
      }
      const date = resolveDate();
      const r = await fetch(`${api}/line/slots?date=${encodeURIComponent(date)}`);
      const j = await r.json().catch(()=> ({}));
      if (Array.isArray(j?.slots)) {
        window.slots = j.slots;
        // ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ«ãŒã‚ã‚Œã°æ›´æ–°ã•ã‚Œã‚‹ã‚ˆã†ã«ã‚¤ãƒ™ãƒ³ãƒˆæŠ•ã’ã‚‹ï¼ˆä»»æ„ï¼‰
        window.dispatchEvent(new Event("auto-slots-ready"));
        console.log("[auto-slots] loaded", { date, count: j.slots.length });
      } else {
        console.warn("[auto-slots] slots not array", j);
      }
    } catch (e) {
      console.warn("[auto-slots] failed", e);
    }
  }

  // 5) DOM æº–å‚™ã§ããŸã‚‰ä¸€åº¦ã ã‘èª­ã¿è¾¼ã¿
  document.addEventListener("DOMContentLoaded", () => {
    // date æœªå…¥åŠ›ãªã‚‰å½“æ—¥ã‚’ã‚»ãƒƒãƒˆï¼ˆUIãŒ #date ã‚’æŒã£ã¦ã„ã‚Œã°ï¼‰
    const el = document.getElementById("date");
    if (el && !el.value) {
      el.value = fmt(new Date());
    }
    loadSlotsOnce();
  });

  // 6) æ—¥ä»˜å¤‰æ›´æ™‚ã«ã‚‚å†å–å¾—ï¼ˆ#date ãŒã‚ã‚Œã°ï¼‰
  document.addEventListener("change", (ev) => {
    const t = ev.target;
    if (t && t.id === "date") {
      loadSlotsOnce();
    }
  });
})();
</script>
<!-- POPUP-GESTURE FIX (injected) -->
<script>
(() => {
  if (window.__popupGestureFixInstalled) return;
  window.__popupGestureFixInstalled = true;

  // æ—¢å­˜ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã«ä¾å­˜ï¼ˆç„¡ã‘ã‚Œã°æœ€å°é™ã‚’å®šç¾©ï¼‰
  const pad = (n)=>String(n).padStart(2,'0');
  const toCalTime = (iso)=>{ const d=new Date(iso);
    return `${d.getUTCFullYear()}${pad(d.getUTCMonth()+1)}${pad(d.getUTCDate())}T${pad(d.getUTCHours())}${pad(d.getUTCMinutes())}${pad(d.getUTCSeconds())}Z`; };
  const buildTitle = (info) => {
    const base = info?.name ? `${info.name} ã•ã‚“ã®ã”äºˆç´„` : 'ã”äºˆç´„';
    return info?.label ? `${base}ï¼ˆ${info.label}ï¼‰` : base;
  };
  const buildGoogleCalendarUrl = (info) => {
    const start = toCalTime(info.start), end = toCalTime(info.end);
    const text  = encodeURIComponent(info.title || 'ã”äºˆç´„');
    const details = encodeURIComponent(info.description || '');
    return `https://www.google.com/calendar/render?action=TEMPLATE&text=${text}&dates=${start}/${end}&details=${details}`;
  };
  async function getLatestReservationInfo(){
    if (window.__calendarInfo) return window.__calendarInfo;
    let slots = Array.isArray(window.slots) ? window.slots : [];
    if (!slots.length) {
      const date = (document.getElementById('date')?.value||'');
      const api  = window.API_BASE;
      if (api && date) {
        try { const r = await fetch(`${api}/line/slots?date=${encodeURIComponent(date)}`);
          const j = await r.json(); if (Array.isArray(j?.slots)) slots = j.slots;
        } catch(e) { console.warn('fetch slots failed', e); }
      }
    }
    if (!slots.length) throw new Error('slots empty');
    const name = (document.getElementById('name')?.value||'').trim();
    const sel  = slots[0];
    const info = { start: sel.start, end: sel.end, label: sel.label||'', name, slotId: sel.id };
    window.__calendarInfo = info;
    return info;
  }

  // ğŸ”‘ ãƒã‚¤ãƒ³ãƒˆ: ã‚¯ãƒªãƒƒã‚¯ç›´å¾Œã«ã‚¿ãƒ–ã‚’é–‹ã„ã¦â€œãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã®æ–‡è„ˆâ€ã‚’ç¢ºä¿
  async function openGCalSafely(){
    // 1) å…ˆã«ç©ºã‚¿ãƒ–
    const w = window.open('about:blank', '_blank', 'noopener');
    if (!w) { alert('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚è¨±å¯ã—ã¦ã‚‚ã†ä¸€åº¦ã€‚'); return; }
    try {
      const info = await getLatestReservationInfo();
      const payload = { start: info.start, end: info.end, title: buildTitle(info), description: `Slot: ${info.slotId||''}` };
      const url = buildGoogleCalendarUrl(payload);
      // 2) ç©ºã‚¿ãƒ–ã«é·ç§»
      w.location = url;
    } catch (e) {
      console.warn('openGCalSafely failed', e);
      w.close();
      alert('Googleèµ·å‹•ã«å¤±æ•—');
    }
  }

  function downloadIcsSafe(){
    // ICS ã¯ popup ãƒ–ãƒ­ãƒƒã‚¯ã«ã‹ã‹ã‚Šã«ãã„ãŒã€å¿µã®ãŸã‚ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œç›´å¾Œã«ç”Ÿæˆ
    (async () => {
      try {
        const info = await getLatestReservationInfo();
        const start = toCalTime(info.start), end = toCalTime(info.end);
        const uid = `booking-${Date.now()}@kazukigroup.org`;
        const now = toCalTime(new Date().toISOString());
        const esc = (s)=> String(s||'').replace(/\n/g,'\\n').replace(/,/g,'\\,');
        const ics = [
          "BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//Kazuki Group//Booking//JP","CALSCALE:GREGORIAN",
          "BEGIN:VEVENT",`UID:${uid}`,`DTSTAMP:${now}`,`DTSTART:${start}`,`DTEND:${end}`,
          `SUMMARY:${esc(buildTitle(info))}`,`DESCRIPTION:${esc(`Slot: ${info.slotId||''}`)}`,
          "END:VEVENT","END:VCALENDAR"
        ].join("\\r\\n");
        const blob = new Blob([ics], {type:"text/calendar;charset=utf-8"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'reservation.ics';
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      } catch(e) {
        console.warn('ICS failed', e);
        alert('ICSç”Ÿæˆã«å¤±æ•—');
      }
    })();
  }

  // æ—¢å­˜ãƒœã‚¿ãƒ³ã¸å†é…ç·šï¼ˆæ¯ç§’ãƒã‚§ãƒƒã‚¯ã§å‹•çš„DOMã«ã‚‚è¿½å¾“ï¼‰
  function wire(){
    const g = document.getElementById('btn-google-calendar');
    const i = document.getElementById('btn-ics-calendar');
    if (g && !g.__wiredFix){ g.addEventListener('click', openGCalSafely); g.__wiredFix = true; }
    if (i && !i.__wiredFix){ i.addEventListener('click', downloadIcsSafe); i.__wiredFix = true; }
  }
  document.addEventListener('DOMContentLoaded', wire);
  setInterval(wire, 800);
})();
</script>
<!-- CALENDAR POLISH (injected) -->
<script>
(() => {
  if (window.__calendarPolishInstalled) return;
  window.__calendarPolishInstalled = true;

  // === ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã“ã“ã‹ã‚‰ ===
  const ORG_NAME   = "Kazuki Group";
  const ORG_EMAIL  = "noreply@kazukigroup.org";     // ä»»æ„ï¼ˆICS ORGANIZER è¡¨ç¤ºç”¨ï¼‰
  const PLACE_TEXT = "Kazuki Groupï¼ˆæ±äº¬éƒ½â—‹â—‹åŒºâ—‹â—‹1-2-3ï¼‰"; // ä½æ‰€ or åº—èˆ—å
  const PLACE_URL  = "https://kazukigroup.org";     // åº—èˆ—URL/LP
  const CANCEL_URL_BASE = "https://kazukigroup.org/cancel?id="; // äºˆç´„IDã‚’é€£çµï¼ˆä¾‹ï¼‰
  // === ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã“ã“ã¾ã§ ===

  // æ—¢å­˜ã® title ãƒ­ã‚¸ãƒƒã‚¯ã‚’å°Šé‡
  const pad = (n)=>String(n).padStart(2,"0");
  const toCalTime = (iso)=>{ const d=new Date(iso);
    return `${d.getUTCFullYear()}${pad(d.getUTCMonth()+1)}${pad(d.getUTCDate())}T${pad(d.getUTCHours())}${pad(d.getUTCMinutes())}${pad(d.getUTCSeconds())}Z`; };
  const buildTitle = (info) => {
    const base = info?.name ? `${info.name} ã•ã‚“ã®ã”äºˆç´„` : 'ã”äºˆç´„';
    return info?.label ? `${base}ï¼ˆ${info.label}ï¼‰` : base;
  };

  // Google ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ URLï¼ˆlocation è¿½åŠ ç‰ˆï¼‰
  window.buildGoogleCalendarUrl = function(info) {
    const start = toCalTime(info.start), end = toCalTime(info.end);
    const text  = encodeURIComponent(info.title || 'ã”äºˆç´„');
    const details = encodeURIComponent(info.description || '');
    const loc  = encodeURIComponent(PLACE_TEXT);
    // location ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ 
    return `https://www.google.com/calendar/render?action=TEMPLATE&text=${text}&dates=${start}/${end}&details=${details}&location=${loc}`;
  };

  // ICS ç”Ÿæˆï¼ˆLOCATION/URL/STATUS/ORGANIZER/TRANSP ã‚’è¿½åŠ ï¼‰
  window.downloadIcs = function(info){
    const start = toCalTime(info.start), end = toCalTime(info.end);
    const uid = `booking-${Date.now()}@kazukigroup.org`;
    const now = toCalTime(new Date().toISOString());
    const esc=(s)=>String(s||'').replace(/\r?\n/g,'\\n').replace(/,/g,'\\,');
    const ics = [
      "BEGIN:VCALENDAR",
      "VERSION:2.0",
      "PRODID:-//Kazuki Group//Booking//JP",
      "CALSCALE:GREGORIAN",
      "METHOD:PUBLISH",
      "BEGIN:VEVENT",
      `UID:${uid}`,
      `DTSTAMP:${now}`,
      `DTSTART:${start}`,
      `DTEND:${end}`,
      `SUMMARY:${esc(info.title||'ã”äºˆç´„')}`,
      `DESCRIPTION:${esc(info.description||'')}`,
      `LOCATION:${esc(PLACE_TEXT)}`,
      `URL:${PLACE_URL}`,
      "STATUS:CONFIRMED",
      "TRANSP:OPAQUE",
      `ORGANIZER;CN=${esc(ORG_NAME)}:mailto:${ORG_EMAIL}`,
      "END:VEVENT",
      "END:VCALENDAR"
    ].join("\\r\\n");
    const blob = new Blob([ics], {type:"text/calendar;charset=utf-8"});
    const url  = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'reservation.ics';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  };

  // showCalendarOptions ã® payload ã‚’æ‹¡å¼µï¼ˆdescription ã«ãƒªãƒƒãƒæƒ…å ±ï¼‰
  const _show = window.showCalendarOptions;
  window.showCalendarOptions = function(info){
    const reserveId = info?.slotId ? `S-${String(info.slotId).replace(/[^a-zA-Z0-9_-]/g,'')}` : '';
    const title = buildTitle(info);
    const details = [
      `äºˆç´„ID: ${reserveId}`,
      `åº—èˆ—: ${ORG_NAME}`,
      `å ´æ‰€: ${PLACE_TEXT}`,
      `Web: ${PLACE_URL}`,
      reserveId ? `ã‚­ãƒ£ãƒ³ã‚»ãƒ«: ${CANCEL_URL_BASE}${reserveId}` : ''
    ].filter(Boolean).join("\\n");

    const payload = { start: info.start, end: info.end, title, description: details, slotId: info.slotId };

    // æ—¢å­˜UIã®ã‚¯ãƒªãƒƒã‚¯å‡¦ç†ã‚’å®‰å…¨ã«å¼µã‚Šæ›¿ãˆ
    const g = document.getElementById('btn-google-calendar');
    const i = document.getElementById('btn-ics-calendar');

    if (g && !g.__polished) {
      g.addEventListener('click', () => {
        try {
          // about:blank ã‚ªãƒ¼ãƒ—ãƒ³ â†’ URLé·ç§»ï¼ˆPopupå¯¾ç­–ï¼‰
          const w = window.open('about:blank','_blank','noopener'); 
          if (!w) { alert('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¨±å¯ã—ã¦ã‚‚ã†ä¸€åº¦æŠ¼ã—ã¦ã­ã€‚'); return; }
          w.location = window.buildGoogleCalendarUrl(payload);
        } catch { alert('Googleèµ·å‹•ã«å¤±æ•—'); }
      });
      g.__polished = true;
    }
    if (i && !i.__polished) {
      i.addEventListener('click', () => {
        try { window.downloadIcs(payload); } catch { alert('ICSç”Ÿæˆã«å¤±æ•—'); }
      });
      i.__polished = true;
    }

    // å…ƒã®è¡¨ç¤ºå‡¦ç†ã‚’ç¶­æŒ
    try { if (typeof _show === 'function') _show(info); } catch {}
  };
})();
</script>
</body>
</html>
