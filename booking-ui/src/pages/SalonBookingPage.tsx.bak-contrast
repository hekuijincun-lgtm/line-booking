import React, { useState, useEffect } from "react";
import BookingLayout from "../components/BookingLayout";
import { BookingCard } from "../components/BookingCard";
import { PrimaryButton } from "../components/PrimaryButton";

type Slot = {
  id: string;
  label: string;
  note?: string;
  status: "available" | "booked";
};

const mockSlots: Slot[] = [
  { id: "s-10-00", label: "10:00ã€œ11:00", note: "ç©ºãã‚ã‚Š", status: "available" },
  { id: "s-12-00", label: "12:00ã€œ13:00", note: "ç©ºãã‚ã‚Š", status: "available" },
  { id: "s-15-00", label: "15:00ã€œ16:00", note: "ç©ºãã‚ã‚Š", status: "available" },
];

const API_BASE =
  import.meta.env.VITE_BOOKING_API_BASE ||
  "https://saas-api.hekuijincun.workers.dev";

const SalonBookingPage: React.FC = () => {
  const [selectedMenuId, setSelectedMenuId] = useState<string>("menu-cut-color");
  const [selectedSlotId, setSelectedSlotId] = useState<string | null>(null);
  const [isSubmitting, setIsSubmitting] = useState(false);

  const [slots, setSlots] = useState<Slot[]>(mockSlots);
  const [isLoadingSlots, setIsLoadingSlots] = useState(true);
  const [slotsError, setSlotsError] = useState<string | null>(null);

  const [reserveMessage, setReserveMessage] = useState<string | null>(null);

  // é€£çµ¡å…ˆ
  const [name, setName] = useState<string>("");
  const [phone, setPhone] = useState<string>("");
  const [memo, setMemo] = useState<string>("");

  useEffect(() => {
    const fetchSlots = async () => {
      try {
        setIsLoadingSlots(true);
        setSlotsError(null);

        const res = await fetch(API_BASE + "/line/slots", {
          method: "GET",
        });

        if (!res.ok) {
          throw new Error("Failed to load slots: " + res.status);
        }

        const data = await res.json();

        const rawSlots: any[] = Array.isArray(data)
          ? data
          : Array.isArray((data as any).slots)
          ? (data as any).slots
          : [];

        if (!rawSlots.length) {
          console.warn("[BookingUI] /line/slots returned empty slots.", data);
          setSlots(mockSlots);
          return;
        }

        const mapped: Slot[] = rawSlots.map((s: any, index: number) => {
          const id = s.slotId ?? s.id ?? String(index);
          const label =
            s.label ??
            s.time ??
            s.startsAt ??
            s.startTime ??
            "æ  " + String(index + 1);
          const isBooked =
            (s.isBooked as boolean | undefined) ??
            (s.booked as boolean | undefined) ??
            (s.available === false);

          return {
            id,
            label,
            note: !isBooked ? s.note ?? "ç©ºãã‚ã‚Š" : s.note ?? "äºˆç´„æ¸ˆã¿",
            status: isBooked ? "booked" : "available",
          };
        });

        setSlots(mapped);
      } catch (err) {
        console.error("[BookingUI] Failed to fetch slots:", err);
        setSlotsError(
          "ãŸã ã„ã¾äºˆç´„æ ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"
        );
        setSlots(mockSlots);
      } finally {
        setIsLoadingSlots(false);
      }
    };

    fetchSlots();
  }, []);

  const handleReserveClick = async () => {
    if (!selectedSlotId) {
      alert("ã”å¸Œæœ›ã®æ™‚é–“å¸¯ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
      return;
    }

    if (!name.trim()) {
      alert("ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      return;
    }

    setIsSubmitting(true);
    setReserveMessage(null);

    try {
      const body = {
        slotId: selectedSlotId,
        name,
        phone: phone || null,
        memo: memo || null,
        menuId: selectedMenuId,
        source: "web-ui",
      };

      const res = await fetch(API_BASE + "/line/reserve", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(body),
      });

      const text = await res.text();
      let json: any = null;
      try {
        json = text ? JSON.parse(text) : null;
      } catch {
        // JSON ã§ãªã„å ´åˆã¯ãã®ã¾ã¾ç„¡è¦–
      }

      if (!res.ok) {
        console.error("[BookingUI] reserve failed:", res.status, text);
        setReserveMessage(
          "äºˆç´„ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚LINEã‹ã‚‰ã®äºˆç´„ã¯å•é¡Œãªãã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚"
        );
        return;
      }

      const reservationId =
        json?.reservationId ?? json?.id ?? json?.data?.id ?? null;

      // äºˆç´„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      if (reservationId) {
        setReserveMessage(
          "ã”äºˆç´„ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚ï¼ˆäºˆç´„ID: " + String(reservationId) + "ï¼‰"
        );
      } else {
        setReserveMessage("ã”äºˆç´„ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚");
      }

      // ğŸ”” äºˆç´„æˆåŠŸæ™‚ã« /line/notify ã‚’å©ã„ã¦ LINE ã«é€šçŸ¥
      if (reservationId) {
        try {
          fetch(API_BASE + "/line/notify", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              reserveId: reservationId,
              source: "web-ui",
            }),
          }).catch((err) => {
            console.error(
              "[BookingUI] failed to call /line/notify (network error)",
              err
            );
          });
        } catch (err) {
          console.error("[BookingUI] failed to enqueue /line/notify", err);
        }
      }
    } catch (err) {
      console.error("[BookingUI] reserve error:", err);
      setReserveMessage(
        "ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã«ã‚ˆã‚Šäºˆç´„ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"
      );
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <BookingLayout
      title="Luxe Hair Tokyo ã”äºˆç´„"
      subtitle="ã‚«ãƒƒãƒˆ / ã‚«ãƒ©ãƒ¼ / ãƒˆãƒªãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆã‚’ã€24æ™‚é–“ã„ã¤ã§ã‚‚ã‚ªãƒ³ãƒ©ã‚¤ãƒ³äºˆç´„ã€‚"
    >
      {/* ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠ */}
      <BookingCard
        title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é¸æŠ"
        description="ã”å¸Œæœ›ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¨æ‹…å½“ã‚¹ã‚¿ã‚¤ãƒªã‚¹ãƒˆã‚’ãŠé¸ã³ãã ã•ã„ã€‚"
      >
        <div className="space-y-2 text-sm">
          <button
            type="button"
            onClick={() => setSelectedMenuId("menu-cut-color")}
            className={
              "flex w-full items-center justify-between rounded-2xl border px-4 py-3 text-left transition " +
              (selectedMenuId === "menu-cut-color"
                ? "border-kb-navy bg-white shadow-kb-subtle"
                : "border-kb-border bg-kb-bg hover:border-kb-navy/70")
            }
          >
            <div>
              <div className="font-medium text-kb-textMain">
                ã‚«ãƒƒãƒˆï¼‹ã‚«ãƒ©ãƒ¼
              </div>
              <div className="text-xs text-kb-textMuted">ç›®å®‰æ™‚é–“ï¼š120åˆ†</div>
            </div>
            <div className="text-right text-sm font-semibold text-kb-navy">
              Â¥13,200
            </div>
          </button>
        </div>
      </BookingCard>

      {/* æ—¥æ™‚ã‚’é¸æŠ */}
      <BookingCard
        title="æ—¥æ™‚ã‚’é¸æŠ"
        description={
          slotsError ??
          "ã”å¸Œæœ›ã®æ™‚é–“å¸¯ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚â€»æ ã¯è‡ªå‹•æ›´æ–°ã•ã‚Œã¾ã™ã€‚"
        }
      >
        {isLoadingSlots && (
          <div className="mb-3 text-xs text-kb-textMuted">
            äºˆç´„æ ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™â€¦
          </div>
        )}

        <div className="grid grid-cols-2 gap-3 md:grid-cols-4">
          {slots.map((slot) => {
            const isSelected = slot.id === selectedSlotId;
            const isDisabled = slot.status === "booked";

            return (
              <button
                key={slot.id}
                type="button"
                disabled={isDisabled}
                onClick={() => setSelectedSlotId(slot.id)}
                className={
                  "flex flex-col items-center justify-center rounded-2xl border px-3 py-3 text-sm transition " +
                  (isDisabled
                    ? "cursor-not-allowed border-kb-border bg-kb-bg text-kb-textMuted opacity-60"
                    : isSelected
                    ? "border-kb-navy bg-kb-navy text-white shadow-kb-subtle"
                    : "border-kb-border bg-white text-kb-textMain hover:border-kb-navy/70 hover:shadow-kb-subtle")
                }
              >
                <span className="text-sm font-semibold">{slot.label}</span>
                {slot.note && (
                  <span
                    className={
                      "mt-1 text-[11px] " +
                      (isSelected ? "text-kb-goldSoft" : "text-kb-textMuted")
                    }
                  >
                    {slot.note}
                  </span>
                )}
              </button>
            );
          })}
        </div>
      </BookingCard>

      {/* ã”é€£çµ¡å…ˆ */}
      <BookingCard
        title="ã”é€£çµ¡å…ˆ"
        description="ã”äºˆç´„ç¢ºèªã®ãŸã‚ã€ãŠåå‰ã¨ãŠé›»è©±ç•ªå·ã‚’ã”å…¥åŠ›ãã ã•ã„ã€‚"
      >
        <div className="space-y-3 text-sm">
          <div>
            <label className="block text-xs text-kb-textMuted mb-1">
              ãŠåå‰ï¼ˆå¿…é ˆï¼‰
            </label>
            <input
              type="text"
              value={name}
              onChange={(e) => setName(e.target.value)}
              className="w-full rounded-2xl border border-kb-border bg-white px-3 py-2 text-sm text-kb-textMain focus:outline-none focus:ring-2 focus:ring-kb-navy/40 focus:border-kb-navy"
              placeholder="ä¾‹ï¼‰å±±ç”° å¤ªéƒ"
            />
          </div>
          <div>
            <label className="block text-xs text-kb-textMuted mb-1">
              ãŠé›»è©±ç•ªå·ï¼ˆä»»æ„ï¼‰
            </label>
            <input
              type="tel"
              value={phone}
              onChange={(e) => setPhone(e.target.value)}
              className="w-full rounded-2xl border border-kb-border bg-white px-3 py-2 text-sm text-kb-textMain focus:outline-none focus:ring-2 focus:ring-kb-navy/40 focus:border-kb-navy"
              placeholder="ä¾‹ï¼‰090-1234-5678"
            />
          </div>
          <div>
            <label className="block text-xs text-kb-textMuted mb-1">
              ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰
            </label>
            <textarea
              value={memo}
              onChange={(e) => setMemo(e.target.value)}
              className="w-full rounded-2xl border border-kb-border bg-white px-3 py-2 text-sm text-kb-textMain focus:outline-none focus:ring-2 focus:ring-kb-navy/40 focus:border-kb-navy"
              placeholder="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚„ã”å¸Œæœ›ãªã©"
              rows={3}
            />
          </div>
        </div>

        {reserveMessage && (
          <div className="mt-3 text-xs text-kb-textMuted">
            {reserveMessage}
          </div>
        )}

        <PrimaryButton
          fullWidth
          onClick={handleReserveClick}
          disabled={isSubmitting}
          className={isSubmitting ? "mt-4 opacity-80" : "mt-4"}
        >
          {isSubmitting
            ? "äºˆç´„å‡¦ç†ä¸­..."
            : selectedSlotId
            ? "ã“ã®å†…å®¹ã§äºˆç´„ã‚’ç¢ºå®šã™ã‚‹"
            : "æ™‚é–“å¸¯ã‚’é¸ã‚“ã§äºˆç´„ã«é€²ã‚€"}
        </PrimaryButton>
      </BookingCard>
    </BookingLayout>
  );
};

export default SalonBookingPage;


